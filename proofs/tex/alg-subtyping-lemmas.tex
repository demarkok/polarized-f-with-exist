\begin{theorem}[Soundness of Subtyping Algorithm] \hfill
    \begin{itemize}
        \item [$-$] 
        If $[[Γ ⊢ Θ]]$, $[[Γ ⊢ iM]]$, and $[[Γ ; Θ ⊢ uN]]$ then\\ 
        $[[Γ ; Θ ⊨ uN ≤ iM ⫤ us]]$
        implies $[[us : Θ|uv uN]]$ and 
        for any $[[us']]$ such that $[[Θ ⊢ us' ⇒ us]]$,
        $[[ Γ ⊢ [us']uN ≤ iM ]]$

        \item [$+$] 
        If $[[Γ ⊢ Θ]]$, $[[Γ ⊢ iQ]]$, and $[[Γ ; Θ ⊢ uP]]$ then\\
        $[[Γ ; Θ ⊨ uP ≥ iQ ⫤ us]]$
        implies $[[us : Θ|uv uP]]$ and 
        for any $[[us']]$ such that $[[Θ ⊢ us' ⇒ us]]$,
        $[[ Γ ⊢ [us']uP ≥ iQ ]]$.
     \end{itemize}
\end{theorem}
\begin{proof}
    We prove it by induction on $[[Γ ; Θ ⊨ uN ≤ iM ⫤ us]]$ (and mutually, on $[[Γ ; Θ ⊨ uP ≥ iQ ⫤ us]]$).
    Let us consider the last rule to infer this judgment. 
    \begin{caseof}
        \item $[[G;Θ ⊨ a⁻ ≤ a⁻ ⫤ ·]]$\\
        Then $[[uv a⁻ = ∅]]$, and $[[us]] = [[· : ·]]$ satisfies $[[us : Θ|∅]]$.
        Since $[[uv a⁻ = ∅]]$, application of any unification solution $[[us']]$ does not change $[[a⁻]]$, i.e.
        $[[ [us']a⁻ = a⁻ ]]$. Therefore, $[[Γ ⊢ [us']a⁻ ≤ a⁻]]$ holds by \ruleref{\ottdruleDOneNVarLabel}.

        \item $[[G;Θ ⊨ ↑uP ≤ ↑iQ ⫤ us]]$\\
        Then the next step of the algorithm is the unification of $[[nf(uP)]]$ and $[[nf(iQ)]]$.
        By the soundness of the unification algorithm (\cref{lemma:unification-soundness}),
        it returns an equivalence-only solution $[[us]]$ such that $[[us : Ord uv uP]]$.
        By \cref{todo}, since $[[us]]$ is equivalence-only and $[[Γ ⊢ Θ]]$, $[[Θ ⊢ us' ⇒ us]]$ means 
        $[[ Γ ⊢ Sub us' ≈ Sub us : Ord uv uP ]]$ as substitutions.

        $[[ [us]nf(uP) = nf(iQ) ]]$ implies $[[Γ ⊢ [us]nf(uP) ≈ nf(iQ)]]$, and then 
        $[[Γ ⊢ [us']nf(uP) ≈ nf(iQ)]]$. \ilyam{add lemmas}

        Let us rewrite the left-hand side and the right-hand side of $[[Γ ⊢ [us']nf(uP) ≈ nf(iQ)]]$ by 
        transitivity of equivalence (\cref{corollary:equivalence-transitivity}).
        By \cref{corollary:nf-sound-wrt-subt-equiv,corollary:subst-pres-equiv},
        $[[Γ ⊢ [us']nf(uP) ≈ [us']uP ]]$. By \cref{corollary:nf-sound-wrt-subt-equiv}, 
        $[[Γ ⊢ nf(iQ) ≈ iQ ]]$. 
        This way, we have $[[Γ ⊢ [us']uP ≈ iQ]]$.
        Then by \ruleref{\ottdruleDOneShiftULabel}
        and congruence of substitution, $[[Γ ⊢ [us']↑uP ≤ ↑iQ]]$.

        \item $[[G;Θ ⊨ uP → uN' ≤ iQ → iM' ⫤ us]]$\\
        The next step of the algorithm is two recursive calls:
        $[[G;Θ ⊨ uP ≥ iQ ⫤ us1]]$ and $[[G;Θ ⊨ uN' ≤ iM' ⫤ us2]]$.
        By the induction hypothesis, 
        \begin{enumerate}
            \item $[[us1 : Θ | uv uP]]$ and $[[ Γ ⊢ [us1']uP ≥ iQ ]]$ for any $[[us1']]$ s.t. $[[Θ ⊢ us1' ⇒ us1]]$
            \item $[[us2 : Θ | uv uN']]$ and $[[ Γ ⊢ [us2']uN' ≤ iM' ]]$ for any $[[us2']]$ s.t. $[[Θ ⊢ us2' ⇒ us2]]$
        \end{enumerate}

        Then the algorithm merges two unification solutions $[[us1]]$ and $[[us2]]$.
        By \cref{lemma:merge-soundness}, since $[[uv uP ∪ uv uN' = uv (uP → uN')]]$, 
        we have $[[us1 & us2 : Θ | uv (uP → uN')]]$, and also
        $[[Θ ⊢ us1 & us2 ⇒ us1]]$ and $[[Θ ⊢ us1 & us2 ⇒ us2]]$.
        By the transitivity of solution weakening (\cref{lemma:weakening-transitivity}),
         $[[Θ ⊢ us' ⇒ us1 & us2]]$ implies $[[Θ ⊢ us' ⇒ us1]]$ and $[[Θ ⊢ us' ⇒ us2]]$.

% \[\begin{tikzcd}[arrows=Rightarrow]
% 	& {[[us']]} \\
% 	{[[us1]]} & {[[us1 & us2]]} & {[[us2]]}
% 	\arrow[from=2-2, to=2-3]
% 	\arrow[from=2-2, to=2-1]
% 	\arrow[from=1-2, to=2-2]
% \end{tikzcd}\]

        The application of the induction hypothesis gives us 
        $[[Γ ⊢ [us']uP ≥ iQ ]]$ and $[[ Γ ⊢ [us']uN' ≤ iM' ]]$.
        Finally, by \ruleref{\ottdruleDOneArrowLabel}, $[[Γ ⊢ [us'](uP → uN') ≤ iQ → iM']]$.

        \item $[[G;Θ ⊨ ∀pas.uN' ≤ ∀pbs.iM' ⫤ us]]$ s.t. either $[[pas]]$ or $[[pbs]]$ is not empty\\
        Then the algorithm creates fresh unification variables $[[â⁺*[Γ,pbs] ]]$, 
        substitutes the old $[[pas]]$ with them in $[[uN']]$, and makes the recursive call:
        $[[G, pbs; Θ, â⁺*[G, pbs] ⊨ [â⁺*/pas] uN ≤ iM ⫤ us']]$, returning as the resulting solution 
        $[[us]] = [[us' \ {α̂⁺*}]]$.

        Notice that $[[Γ, pbs ⊢ Θ, â⁺*[G, pbs] ]]$, $[[Γ,pbs ⊢ iM']]$, and 
        $[[Γ,pbs; Θ, â⁺*[G, pbs] ⊢ [â⁺*/pas] uN ]]$, so the induction hypothesis is applicable,
        that is $[[us' : Θ | uv [â⁺*/pas]uN']]$ and $[[ Γ, pbs ⊢ [us'2][â⁺*/pas]uN' ≤ iM' ]]$ for any
        $[[us'2]]$ s.t. $[[Θ ⊢ us'2 ⇒ us']]$.

        Since the domain of $[[us']]$ is $[[uv [â⁺*/pas]uN']]$, the domain of 
        $[[us]] = [[us' \  {α̂⁺*}]]$ is $[[uv [â⁺*/pas]uN \ {â⁺*} = uv uN']] = [[uv ∀pas.uN']]$,
        this way, $[[us : Θ | uv ∀pas.uN']]$, as required.

        It is left to show that $[[Γ ⊢ [us2]∀pas.uN' ≤ ∀pbs.iM']]$ for any $[[us2]]$ s.t. $[[Θ ⊢ us2 ⇒ us]]$.
        Let us consider an arbitrary such $[[us2]]$. Let us construct $[[us'2]]$, 
        extending $[[us2]]$ to the domain $[[Ord uv [â⁺*/pas]uN']]$ with the values of $[[us']]$,
        i.e.  $[[us'2 : Θ | uv [â⁺*/pas]uN']]$, 
        and
        \[
            [[us'2(β̂±)]]  = 
            \begin{cases}
               [[us2(β̂±)]] & \text{if } [[β̂±]] \in [[uv uN']] \\
               [[us'(β̂±)]] & \text{if } [[β̂±]] \in [[â⁺*]]
            \end{cases}
        \] 
        , where the application of the unification solution to a variable returns the 
        corresponding \emph{unification entry}. 
        Notice that $[[Sub us'2|uv uN']] = [[us2]]$.
    It is easy to see that $[[Θ ⊢ us'2 ⇒ us']]$: 
    \begin{enumerate}
        \item if $[[β̂±]] \in [[uv uN']]$ then $[[us'2(β̂±)]] = [[us2(β̂±)]] \Rightarrow [[us(β̂±)]] = [[us'(β̂±)]]$;
        \item it $[[β̂±]] \in [[â⁺*]]$ then $[[us'2(β̂±)]] = [[us'(β̂±)]] \Rightarrow [[us'(β̂±)]]$,
    \end{enumerate}
    which means that the induction hypothesis can be applied to $[[us'2]]$, i.e.
    $[[ Γ, pbs ⊢ [us'2][â⁺*/pas]uN' ≤ iM' ]]$.\\
    Notice that
    $
    \begin{aligned}[t]
                 [[ [us'2][â⁺*/pas]uN' ]] &= [[ [Sub us'2|{â⁺*} ○ â⁺*/pas][Sub us'2|uv uN']uN' ]]
                                          && \text{by substitution properties \ilyam{todo}}\\
                                          &= [[ [Sub us'2|{â⁺*} ○ â⁺*/pas][us2]uN' ]]
                                          && \text{since $[[Sub us'2|uv uN']] = [[us2]]$}.
    \end{aligned}
    $\\
    Also notice that the domain of $[[Sub us'2|{â⁺*} ○ â⁺*/pas]]$ is $[[pas]]$,
    and the range is $[[Γ, pbs]]$, i.e. $[[Γ, pbs ⊢ Sub us'2|{â⁺*} ○ â⁺*/pas : pas]]$, 
    which means that we can apply \ruleref{\ottdruleDOneForallLabel} to 
    $[[ Γ, pbs ⊢ [Sub us'2|{â⁺*} ○ â⁺*/pas][us2]uN' ≤ iM' ]]$
    to get $[[ Γ ⊢ [us2]∀pas.uN' ≤ ∀pbs.iM' ]]$, as required.

    \item $[[Γ;Θ ⊨ â⁺ ≥ iP' ⫤ (â⁺ :≥ iQ')]]$ where
    $[[â⁺[Δ] ∊ Θ]]$ and $[[upgrade G ⊢ iP' to Δ = iQ']]$\\

    Notice that $[[â⁺[Δ] ∊ Θ]]$ and $[[Γ ⊢ Θ]]$ 
    implies $[[Γ = Δ, pnas]]$ for some $[[pnas]]$, hence, the
    soundness of upgrade (\cref{lemma:upgrade-soundness}) is applicable:
    \begin{enumerate}
        \item $[[Δ ⊢ iQ']]$ and
        \item $[[Γ ⊢ iQ ≥ iP]]$.
    \end{enumerate}

    Since $[[â⁺[Δ] ∊ Θ|uv â⁺]]$ and $[[Δ ⊢ iQ']]$, it is clear that $[[(â⁺ :≥ iQ') : Θ | uv â⁺ ]]$.

    It is left to show that $[[Γ ⊢ [us']â⁺ ≥ iP']]$ for any $[[us']]$ s.t. $[[Θ ⊢ us' ⇒ (â⁺ :≥ iQ')]]$.
    The latter weakening statement means that either $[[us']] \ni [[â⁺ :≥ iQ'']]$ or
    $[[us']] \ni [[(â⁺ :≈ iQ'')]]$ for $[[Δ ⊢ iQ'' ≥ iQ']]$. In any case,
    $[[Δ ⊢ [us']â⁺ ≥ iQ]]$. By weakening the context to $[[Γ]]$ and combining this judgment
    transitivity (\cref{todo}) with $[[Γ ⊢ iQ ≥ iP]]$, we have $[[Γ ⊢ [us']â⁺ ≥ iP]]$,
    as required. 

    \item For the other positive cases, the proof is symmetric to the corresponding negative cases.
    \end{caseof}
\end{proof}

Notice that the induction statement in following theorem is not symmetric for the positive and negative cases.
\begin{theorem}[Completeness and Initiality of the Subtyping Algorithm]
    \hfill
    \begin{itemize}
        \item [$-$] Suppose that $[[Γ ⊢ Θ]]$, $[[Γ ⊢ iM]]$, $[[Γ ; Θ ⊢ uN]]$,
        $[[uN]]$ does not contain negative unification variables ($[[α̂⁻]] \notin [[uv uN]]$)
        and there exists $[[us : Θ | uv uN]]$ such that $[[ Γ ⊢ [us]uN ≤ iM ]]$.
        Then there exists $[[us']]$ such that $[[Γ ; Θ ⊨ uN ≤ iM ⫤ us']]$
        and $[[Θ ⊢ us ⇒ us']]$.
        
        \item [$+$] Suppose that $[[Γ ⊢ Θ]]$, $[[Γ ⊢ iQ]]$ and $[[Γ ; Θ ⊢ uP]]$ and
        there exists $[[us : Θ | uv uP]]$ such that $[[ Γ ⊢ [us]uP ≥ iQ ]]$.
        Then there exists $[[us']]$ such that $[[Γ ; Θ ⊨ uP ≥ iQ ⫤ us']]$
        and $[[Θ ⊢ us ⇒ us']]$.
    \end{itemize}
\end{theorem}
\begin{proof}
    We prove it by induction on $[[ Γ ⊢ [us]uN ≤ iM ]]$ (and mutually, on $[[ Γ ⊢ [us]uP ≥ iQ ]]$).
    Let us consider the last rule used in the derivation of $[[ Γ ⊢ [us]uN ≤ iM ]]$ or $[[ Γ ⊢ [us]uP ≥ iQ ]]$,
    but first consider the base case for the substitution $[[ [us]uP ]]$:
    \begin{caseof}
        \item \label{case:subt-complete-base} $[[uP]] = [[ ∃nbs.α̂⁺ ]]$ (for potentially empty $[[pbs]]$)\\
        Then by assumption, there exists $[[us : Θ | uv uP]]$ such that $[[ Γ ⊢ ∃nbs.[us]α̂⁺ ≥ iQ ]]$.
        $[[us : Θ | uv α̂⁺]]$ means that  $[[us]]$ is either $[[ (α̂⁺ :≈ iP') ]]$ or $[[ (α̂⁺ :≥ iP') ]]$,
        where $[[Δ ⊢ iP']]$ and $[[α̂⁺[Δ] ∊ Θ]]$.
        $[[ Γ ⊢ ∃nbs.[us]α̂⁺ ≥ iQ ]]$ means that $[[Γ ⊢ iP' ≥ iQ]]$
        because multiple inversions of \ruleref{\ottdruleDOneExistsLabel} 
        gives us $[[Γ ⊢ [us]α̂⁺ ≥ iQ]]$ since $[[ {nbs} ∩ fv [us]α̂⁺ = ∅]]$.


        In the algorithm, after multiple applications of \ruleref{\ottdruleAExistsLabel}
        the type $[[∃nbs.α̂⁺]]$ is reduced to $[[α̂⁺]]$.
        Next, the algorithm tries to apply
        \ruleref{\ottdruleAPUVarLabel}
        and the resulting solution is $[[us']] = [[(α̂⁺ :≥ iQ')]]$ where
        $[[upgrade Γ ⊢ iQ to Δ = iQ']]$.

        Why does the upgrade procedure terminates?
        Because $[[iP']]$ satisfies the pre-conditions of the completeness of the upgrade
        (\cref{lemma:upgrade-completeness})
        :
        \begin{itemize}
            \item $[[Δ ⊢ iP']]$ because $[[iP' = [us]α̂⁺]]$, $[[us : Θ | uv uP]]$ and 
            $[[α̂⁺[Δ] ∊ Θ | uv uP]]$,
            \item $[[Γ ⊢ iP' ≥ iQ]]$ as noted before
        \end{itemize}
        Moreover, completeness of the upgrade also gives us $[[Γ ⊢ iP' ≥ iQ']]$
        and further, we strengthen it to $[[Δ ⊢ iP' ≥ iQ']]$
        (since by the soundness of the upgrade (\cref{lemma:upgrade-soundness}),
        $[[Δ ⊢ iQ']]$).

        It means that $[[Θ ⊢ (α̂⁺ :≈ iP') ⇒ (α̂⁺ :≥ iQ') ]]$ and 
        $[[ Θ ⊢ (α̂⁺ :≥ iP') ⇒ (α̂⁺ :≥ iQ') ]]$, which means that in any case, 
        $[[ Θ ⊢ us ⇒ us']]$.

        \item \label{case:subt-complete-nvar}
        $[[ Γ ⊢ [us]uN ≤ iM ]]$ is derived by \ruleref{\ottdruleDOneNVarLabel}, 
        i.e. $[[ [us]uN ]] = [[iM]] = [[ α⁻ ]] = [[iN]]$ 
        (the latter equality holds because $[[uN]] \neq [[α̂⁻]]$).

        Notice that $[[us : Θ | uv α⁻]]$ = $[[us : Θ | ∅]]$ = $[[·]]$.

        The algorithm applies \ruleref{\ottdruleANVarLabel} and 
        infers $[[us']] = [[·]]$, i.e. $[[Γ;Θ ⊨ a⁻ ≤ a⁻ ⫤ ·]]$.

        Since $[[Θ ⊢ · ⇒ ·]]$, we have $[[Θ ⊢ us ⇒ us']]$.

        \item $[[ Γ ⊢ [us]uN ≤ iM ]]$ is derived by \ruleref{\ottdruleDOneShiftULabel},
        \label{case:subt-complete-upshift}
        i.e. $[[ [us]uN ]] = [[ ↑[us]uP ]]$ (since the substitution $[[ [us]uN ]]$ must preserve the 
        top-level constructor of $[[uN]]\neq [[α̂⁻]]$), and $[[uM]] = [[ ↑iQ ]]$,
        and by inversion, $[[ Γ ⊢ [us]uP ≈ iQ ]]$.

        Since both types start with $[[↑]]$, 
        the algorithm tries to apply \ruleref{\ottdruleAShiftULabel}: 
        $[[G;Θ ⊨ ↑uP ≤ ↑iQ ⫤ us']]$. The premise of this rule is the
        unification of $[[nf(uP)]]$ and $[[nf(iQ)]]$:
        $[[Γ;Θ ⊨ nf(uP) ≈u nf(iQ) ⫤ us']]$. Let us show that the unification successfully 
        terminates and returns $[[us']] = [[nf(us)]]$.

        To demonstrate that the unification terminates, we apply the completeness 
        of the unification algorithm (\cref{lemma:unification-completeness}). 
        In order to do that, we need to provide a unifier of 
        $[[nf(uP)]]$ and $[[nf(iQ)]]$. Thankfully, $[[nf(us)]]$ does it. 

        \begin{itemize}
            \item $[[nf(uP)]]$ and $[[nf(iQ)]]$ are normalized 
            \item $[[Γ ; Θ ⊢ nf(uP)]]$ because $[[Γ ; Θ ⊢ uP]]$ (\cref{todo})
            \item $[[Γ ⊢ nf(iQ)]]$ because $[[Γ ⊢ iQ]]$ (\cref{corollary:wf-nf})
            \item $[[nf(us) : Θ | uv nf(uP)]]$ because $[[us: Θ | uv uP]]$ (\cref{todo})
            \item $ \begin{aligned}[t]
                    [[ Γ ⊢ [us]uP ≈ iQ ]] &\Rightarrow [[ [us]uP ≈ iQ ]]
                                          && \text {by \cref{lemma:equiv-completeness}}\\
                                          &\Rightarrow [[ nf([us]uP) = nf(iQ) ]]
                                          && \text {by \cref{lemma:normalization-completeness}}\\
                                          &\Rightarrow [[ [nf(us)]nf(uP) = nf(iQ) ]]
                                          && \text {by \cref{lemma:norm-subst-distr}}\\
                    \end{aligned}
                  $
        \end{itemize}
        Then by the completeness of the unification,
        $[[Γ ; Θ ⊨ nf(uP) ≈u nf(iQ) ⫤ nf(us)]]$.
        This way, the subtyping algorithm terminates and the resulting solution is
        $[[nf(us)]]$. 
        
        It is left to note that $[[Θ ⊢ us ⇒ nf(us)]]$, by \cref{todo}, since $[[Θ ⊢ us ≈ nf(us)]]$ 

        \item $[[ Γ ⊢ [us]uN ≤ iM ]]$ is derived by \ruleref{\ottdruleDOneArrowLabel}, 
        i.e. $[[ [us]uN ]] = [[ [us]uP → [us]uN' ]]$ and $[[iM]] = [[iQ → iM']]$, 
        and by inversion, $[[ Γ ⊢ [us]uP ≥ iQ ]]$ and $[[ Γ ⊢ [us]uN' ≤ iM' ]]$.

        Let us consider restrictions of $[[us]]$ to 
        the set of unification variables in $[[uP]]$ and $[[uN']]$:
        $[[us | uv uP : Θ | uv uP]]$ and $[[us | uv uN' : Θ | uv uN']]$.
        Notice that 
        $[[ [us]uP = [us | uv uP]uP ]]$ and 
        $[[ [us]uN' = [us | uv uN']uN' ]]$.

       Let us apply the induction hypothesis to
       $[[ Γ ⊢ [us | uv uP]uP ≥ iQ ]]$ and
       $[[ Γ ⊢ [us | uv uN']uN' ≤ iM' ]]$ (notice that
       since $[[uv uN' ⊆ uv uN]]$, there are no negative unification variables in $[[uN']]$)
       to obtain $[[us'1]]$ and $[[us'2]]$ such that
       \begin{enumerate}
        \item $[[Γ; Θ ⊨ uP ≥ iQ ⫤ us'1]]$ and $[[Θ ⊢ us | uv uP ⇒ us'1]]$
        \item $[[Γ; Θ ⊨ uP ≥ iQ ⫤ us'2]]$ and $[[Θ ⊢ us | uv uN' ⇒ us'2]]$ 
       \end{enumerate}
       
       This way, the algorithm applies \ruleref{\ottdruleAArrowLabel}
       and terminates returning $[[us'1 & us'2]]$ as the result.

       It is left to show that $[[Θ ⊢ us ⇒ us'1 & us'2]]$.
       Since $[[us | uv uP ⊆ us]]$, 
       by \cref{lemma:weakening-monotonicity}, 
       $[[Θ ⊢ us ⇒ us | uv uP]]$,
       and then by \cref{lemma:weakening-transitivity}, 
       $[[Θ ⊢ us | uv uP ⇒ us'1]]$.
       Analogously, $[[Θ ⊢ us | uv uN' ⇒ us'2]]$.
       Then since by \cref{lemma:merge-completeness}, 
       $[[us'1 & us'2]]$ is the weakest restriction  
       implying both $[[us'1]]$ and $[[us'2]]$,
       we have $[[Θ ⊢ us ⇒ us'1 & us'2]]$, as required.

       \item \label{case:subt-complete-forall}
       $[[ Γ ⊢ [us]uN ≤ iM ]]$ is derived by \ruleref{\ottdruleDOneForallLabel},
       i.e. $[[ [us]uN ]] = [[ ∀pas.[us]uN' ]]$
       (assuming $[[pas]]$ does not intersect with the 
       range of $[[us]]$)
       and 
       $[[iM]] = [[∀pbs.iM']]$, where either $[[pas]]$ or $[[pbs]]$
       is non-empty.
       
       By inversion, 
       $[[ Γ, pbs ⊢ [σ][us]uN' ≤ iM' ]]$ for 
       $[[Γ, pbs ⊢ σ : pas ]]$.
       Since $[[σ]]$ and $[[us]]$ have disjoint domains,
       and the range of one does not intersect with the domain of the other,
       they commute, i.e. $[[ Γ, pbs ⊢ [us][σ]uN' ≤ iM' ]]$
       (notice that the tree inferring this judgement is 
       a proper subtree of the tree inferring 
       $[[ Γ ⊢ [us]uN ≤ iM ]]$).

       On the next step, 
       the algorithm creates fresh (disjoint with $[[uv uN']]$) 
       unification variables $[[â⁺*]]$, replaces $[[pas]]$ with them in $[[ [us]uN' ]]$,
       and makes the recursive call:
       $[[G, pbs; Θ, â⁺*[G, pbs] ⊨ uN0 ≤ iM ⫤ us1]]$,
       (where $[[uN0]] = [[ [â⁺*/pas]uN' ]]$),
       returning $[[us1 \ {â⁺*}]]$ as the result.

       Notice that $[[ [us][σ][pas/â⁺*]uN0 = [us][σ]uN' ]]$,
       and thus, $[[ Γ, pbs ⊢ [us][σ][pas/â⁺*]uN0 ≤ iM' ]]$.
       Let us combine $[[us]]$ and $[[σ  ○ pas/â⁺*]]$ into one 
       $[[us0]]$ an unification solution for $[[uN0]]$:
        \[
            [[us0(β̂±)]]  = 
            \begin{cases}
               [[ β̂± :≈ [σ]αi⁺ ]] & \text{if } [[β̂±]] = [[αî⁺]] \in [[â⁺*]] \\
               [[us(β̂±)]] & \text{if } [[β̂±]] \in [[uv uN']]
            \end{cases}
       \]

       Let us show that the induction hypothesis is applicable to 
       $[[Γ, pbs ⊢ [us0]uN0 ≤ iM' ]]$.
       \begin{itemize}
        \item $[[ us0 : Θ|uv uN', â⁺*[Γ, pbs] ]]$. Notice that for every $[[αî⁺]]$, 
            the type corresponding to the entry $[[us0(αî⁺)]]$ 
            is well-formed in $[[Γ, pbs]]$ since $[[Γ, pbs ⊢ σ : pas ]]$;
            and for every $[[β̂±]] \in [[uv uN']]$, 
            the type corresponding to the entry $[[us0(β̂±)]]$ is well-formed in
            context $[[Θ(β̂±)]]$ since $[[us : Θ | uv uN']]$.
        \item $[[Γ, pbs ⊢ [us0]uN0 ≤ iM' ]]$. This is because
            $[[ [us0]uN0 ]] = [[ [us][σ][pas/â⁺*]uN0 ]] = [[ [us][σ]uN' ]]$.
        \item $[[ Γ, pbs ⊢ Θ, â⁺*[Γ, pbs] ]]$ since
            $[[Γ, pbs ⊢ Θ]]$ and $[[ {Γ, pbs} ⊆ {Γ, pbs} ]]$.
        \item $[[Γ, pbs ; Θ, â⁺*[Γ, pbs] ⊢ uN0 ]]$
        \item There are no negative unification variables in $[[uN0]]$ because
            $[[ uv uN0 ⊆ uv uN ∪ {â⁺*} ]]$.
       \end{itemize}

       This way, we apply the induction hypothesis to $[[Γ, pbs ⊢ [us0]uN0 ≤ iM' ]]$ and 
       infer that there exists\\
        $[[us0' :  (Θ, â⁺*[Γ, pbs]) | uv uN0]]$ such that
       $[[G, pbs; Θ, â⁺*[G, pbs] ⊨ uN0 ≤ iM ⫤ us0']]$,
       and $[[Θ, â⁺*[G, pbs] ⊢ us0' ⇒ us0]]$.

       This way, the algorithm terminates with the result $[[us0' \ {â⁺*}]]$
       and it is left to show $[[ Θ ⊢ us ⇒ us0' \ {â⁺*} ]]$. Notice that
       $[[us0' \ {â⁺*} : Θ | uv uN' ]]$. This way, to show $[[ Θ ⊢ us ⇒ us0' \
       {â⁺*} ]]$. it suffices to consider an unification variable $[[β̂±]] ∊
       [[uv uN']]$ and show that $[[Γ, pbs ⊢ us(β̂±) ⇒ us0'(β̂±)]]$. It holds by the
       reflexivity of weakening (\cref{lemma:weakening-reflexivity}) since
       $[[us0'(β̂±)]] = [[us(β̂±)]]$.

       \item The positive case when $[[Γ ⊢ [us]uP ≥ iQ]]$ is derived by 
       \ruleref{\ottdruleDOneShiftDLabel} is symmetric to the corresponding negative
        \cref{case:subt-complete-upshift}. Notice that the algorithm does not 
        make a recursive call in this case but rather invoke the unification.
        This way, the proof does not apply the induction hypothesis, and hence, 
        the absence of negative unification variables in a negative type
        ($[[α̂⁻]] \notin [[uN]]$ for $[[↓uN]] =[[uP]]$) is not required.

      \item The positive case when $[[Γ ⊢ [us]uP ≥ iQ]]$ is derived by 
      \ruleref{\ottdruleDOneExistsLabel} is symmetric to the corresponding negative
      \cref{case:subt-complete-forall}. Notice that we only consider the case
      when the substitution $[[ [us]uP ]]$ results in the existential type 
      $[[∃nas.iP']]$ (for $[[iP']] \neq [[∃]]\dots$) by congruence, 
      i.e. $[[uP = ∃nas.uP'']]$ (for $[[uP'']] \neq [[∃]]\dots$) and $[[ [us]uP'' = iP' ]]$.
      This is because the case when $[[uP = ∃nbs.α̂⁺]]$ has been covered
      (\cref{case:subt-complete-base}), and thus, the substitution $[[us]]$ must
      preserve all the outer quantifiers of $[[uP]]$ and does not generate any new ones.

      \item The positive case when $[[Γ ⊢ [us]uP ≥ iQ]]$ is derived by 
      \ruleref{\ottdruleDOnePVarLabel} is symmetric to the corresponding negative
      \cref{case:subt-complete-nvar}.
      Notice that $[[ [us]uP = β⁺ ]]$ 
      implies $[[uP = β⁺]]$ because the case when $[[uP = α̂⁺]]$ has been covered 
      (\cref{case:subt-complete-base}).
    \end{caseof}
\end{proof}


