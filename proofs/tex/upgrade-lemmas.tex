Let us consider a type $[[iP]]$ well-formed in $[[Γ]]$.
Some of its $[[Γ]]$-supertypes are also well-formed in a smaller context $[[{Δ} ⊆ Γ]]$.
The upgrade is the operation that returns the least of such supertypes.

\begin{observation}[Upgrade is deterministic]
    \label{obs:upgrade-deterministic}
    Assuming $[[iP]]$ is well-formed in $[[Γ ⊆ Δ]],$\\
    if $[[upgrade Γ ⊢ iP to Δ = iQ]]$ and $[[upgrade Γ ⊢ iP to Δ = iQ']]$ are defined 
    then $[[iQ = iQ']]$.
\end{observation}
\begin{proof}
    It follows directly from \cref{obs:lub-deterministic},
    and the convention that the fresh variables are chosen by a fixed deterministic algorithm
    (\cref{sec:fresh-selection}).
\end{proof}

\begin{lemma}[Soundness of Upgrade]\label{lemma:upgrade-soundness}
    Assuming $[[iP]]$ is well-formed in $[[Γ = Δ, pnas]]$,
    if $[[upgrade Γ ⊢ iP to Δ = iQ]]$
    then
    \begin{enumerate}
        \item $[[Δ ⊢ iQ]]$
        \item $[[Γ ⊢ iQ ≥ iP]]$
    \end{enumerate}
\end{lemma}
\begin{proof}
    By inversion, $[[upgrade Γ ⊢ iP to Δ = iQ]]$ means that 
    for fresh $[[pnbs]]$ and $[[pncs]]$,
    $[[Δ, pnbs, pncs ⊨ [pnbs/pnas]iP ∨ [pncs/pnas]iP = iQ]]$.
    Then by the soundness of the least upper bound (\cref{lemma:lub-soundness}),
    \begin{enumerate}
        \item $[[Δ, pnbs, pncs ⊢ iQ]]$, 
        \item $[[Δ, pnbs, pncs ⊢ iQ ≥ [pnbs/pnas]iP]]$, and 
        \item $[[Δ, pnbs, pncs ⊢ iQ ≥ [pncs/pnas]iP]]$.
    \end{enumerate}

    $ 
    \begin{aligned}
        [[fv iQ]] &\subseteq [[fv [pnbs/pnas]iP ∩ fv [pncs/pnas]iP]]
                  &&\text{since by \cref{lemma:fv-propagation}, 
                         $[[fv iQ ⊆ fv [pnbs/pnas]iP]]$ and
                         $[[fv iQ ⊆ fv [pncs/pnas]iP]]$}\\
                  &\subseteq [[ ((fv iP \ {pnas}) ∪ {pnbs}) ∩ ((fv iP \ {pnas}) ∪ {pncs})]]\\
                  &= [[ (fv iP \ {pnas}) ∩ (fv iP \ {pnas}) ]]
                  &&\text{since $[[pnbs]]$ and $[[pncs]]$ are fresh}\\
                  &= [[ fv iP \ {pnas} ]]\\
                  &\subseteq [[ Γ \ {pnas} ]]
                  &&\text{since $[[iP]]$ is well-formed in $[[Γ]]$}\\
                  &\subseteq [[ {Δ} ]]\\
    \end{aligned}
    $\\
    This way, by \cref{lemma:wf-ctxt-equiv}, $[[Δ ⊢ iQ]]$.
    
    Let us apply $[[pnas/pnbs]]$---the inverse of the substitution $[[ pnbs/pnas ]]$ to 
    both sides of $[[Δ, pnbs, pncs ⊢ iQ ≥ [pnbs/pnas]iP]]$ and 
    by \cref{lemma:subst-pres-subt} 
    (since $[[pnbs/pnas]]$ can be specified as 
    $[[Δ,pnbs,pncs ⊢ pnbs/pnas : Δ, pnas, pncs]]$ by \cref{lemma:subst-domain-weakening})
    obtain $[[Δ, pnas, pncs ⊢ [pnas/pnbs]iQ ≥ iP]]$.
    Notice that $[[Δ ⊢ iQ]]$ implies that $[[fv iQ ∩ {pnbs} = ∅]]$, 
    then by \cref{corollary:subst-disj}, $[[ [pnas/pnbs]iQ = iQ]]$,
     and thus $[[Δ, pnas, pncs ⊢ iQ ≥ iP]]$.
    By context strengthening, $[[Δ, pnas ⊢ iQ ≥ iP]]$.
\end{proof}

\begin{lemma}[Completeness and Initiality of Upgrade] \label{lemma:upgrade-completeness}
    The upgrade returns the least $[[Γ]]$-supertype of $[[iP]]$ well-formed in $[[Δ]]$.
    Assuming $[[iP]]$ is well-formed in $[[Γ = Δ, pnas]],$\\
    For any $[[iQ']]$ such that 
    \begin{enumerate}
        \item $[[Δ ⊢ iQ']]$ and
        \item $[[Γ ⊢ iQ' ≥ iP]]$,
    \end{enumerate}

    The result of the upgrade algorithm $[[iQ]]$ exists
    ($[[upgrade Γ ⊢ iP to Δ = iQ]]$) and satisfies $[[Δ ⊢ iQ' ≥ iQ]]$.
\end{lemma}
\begin{proof}

    Let us consider fresh (not intersecting with $[[Γ]]$) $[[pnbs]]$ and $[[pncs]]$.

    If we apply substitution $[[pnbs/pnas]]$ to both sides of $[[Δ, pnas ⊢ iQ' ≥ iP]]$,
    we have $[[Δ, pnbs ⊢ [pnbs/pnas]iQ' ≥ [pnbs/pnas]iP]]$, which by  
    \cref{corollary:subst-disj}, since $[[pnas]]$ is disjoint from $[[fv(iQ')]]$
    (because $[[Δ ⊢ iQ']]$), simplifies to $[[Δ, pnbs ⊢ iQ' ≥ [pnbs/pnas]iP]]$.

    Analogously, if we apply substitution $[[pncs/pnas]]$ to both sides of $[[Δ, pnas ⊢ iQ' ≥ iP]]$,
    we have $[[Δ, pncs ⊢ iQ' ≥ [pncs/pnas]iP]]$.

    This way, $[[iQ']]$ is a common supertype of $[[ [pnbs/pnas]iP ]]$ and $[[ [pncs/pnas]iP ]]$ in
    context $[[Δ, pnbs, pncs]]$. It means that we can apply the completeness of the least upper bound
    (\cref{lemma:lub-completeness}):
    \begin{enumerate}
        \item there exists $[[iQ]]$ s.t. $[[Γ ⊨ [pnbs/pnas]iP ∨ [pncs/pnas]iP = iQ]]$ 
        \item $[[Γ ⊢ iQ' ≥ iQ]]$.
    \end{enumerate}
    The former means that the upgrade algorithm terminates and returns $[[iQ]]$.
    The latter means that since both 
    $[[iQ']]$ and $[[iQ]]$ are well-formed in $[[Δ]]$ and $[[Γ]]$,
    by \cref{lemma:subt-ctxt-irrelevance}, $[[Δ ⊢ iQ' ≥ iQ]]$.
\end{proof}


