\begin{lemma}[Soundness of Unification] \label{lemma:unification-soundness}
    \hfill
    \begin{itemize}
        \item [$+$] For normalized $[[uP]]$ and $[[iQ]]$ such that 
        $[[Γ ; Θ ⊢ uP]]$ and $[[Γ ⊢ iQ]]$,\\ 
        if $[[Γ ; Θ ⊨ uP ≈u iQ ⫤ UC]]$ then 
        $[[Θ ⊢ UC]]$ and for any normalized $[[uσ]]$ such that $[[Θ ⊢ uσ : lift UC]]$,
        $[[ [uσ]uP = iQ ]]$.

        \item [$-$] For normalized $[[uN]]$ and $[[iM]]$ such that
        $[[Γ ; Θ ⊢ uN]]$ and $[[Γ ⊢ iM]]$,\\
        if $[[Γ ; Θ ⊨ uN ≈u iM ⫤ UC]]$ then 
        $[[Θ ⊢ UC]]$ and for any normalized $[[uσ]]$ such that $[[Θ ⊢ uσ : lift UC]]$,
        $[[ [uσ]uN = iM ]]$.
    \end{itemize}
\end{lemma}
\begin{proof}
    We prove by induction on the derivation of 
    $[[ Γ ; Θ ⊨ uN ≈u iM ⫤ UC ]]$ and mutually $[[Γ ; Θ ⊨ uP ≈u iQ ⫤ UC]]$.
    Let us consider the last rule forming this derivation. 
    \begin{caseof}
        \item \ruleref{\ottdruleUNVarLabel}, then $[[uN]] = [[α⁻]] = [[iM]]$.
        The resulting unification constraint is empty: $[[UC]] = [[·]]$.
        It satisfies $[[Θ ⊢ UC]]$ vacuously, and $[[ [us]α⁻ = α⁻ ]]$, that is $[[ [us]uN = iM ]]$.

        \item \ruleref{\ottdruleUShiftULabel}, then $[[uN]] = [[↑uP]]$ and $[[iM]] = [[↑iQ]]$.
        The algorithm makes a recursive call to $[[Γ ; Θ ⊨ uP ≈u iQ ⫤ UC]]$ returning $[[UC]]$.
        By induction hypothesis, $[[Θ ⊢ UC]]$ and for any $[[Θ ⊢ uσ : lift UC]]$,
        $[[ [uσ]uN ]] = [[ [uσ]↑uP ]] = [[ ↑[uσ]uP ]] = [[ ↑iQ ]] = [[ iM ]]$, as 
        required.

        \item \ruleref{\ottdruleUArrowLabel}, then $[[uN]] = [[uP → uN']]$ and $[[iM]] = [[iQ → iM']]$.
        The algorithm makes two recursive calls to $[[Γ ; Θ ⊨ uP ≈u iQ ⫤ UC1]]$ and
        $[[Γ ; Θ ⊨ uN' ≈u iM' ⫤ UC2]]$ returning $[[Θ ⊢ UC1 & UC2 = UC]]$ as the result.

        It is clear that $[[uP]]$, $[[uN']]$, $[[iQ]]$, and $[[iM']]$ are normalized,
        and that $[[Γ ; Θ ⊢ uP]]$, $[[Γ ; Θ ⊢ uN']]$, $[[Γ ⊢ iQ]]$, and $[[Γ ⊢ iM']]$.
        This way, the induction hypothesis is applicable to both recursive calls.

        By applying the induction hypothesis to $[[Γ ; Θ ⊨ uP ≈u iQ ⫤ UC1]]$,
        we have:
        \begin{itemize}
            \item $[[Θ ⊢ UC1]]$,
            \item for any $[[Θ ⊢ uσ' : lift UC1]]$, $[[ [uσ']uP = iQ ]]$.
        \end{itemize}
        By applying it to $[[Γ ; Θ ⊨ uN' ≈u iM' ⫤ UC2]]$, we have:
        \begin{itemize}
            \item $[[Θ ⊢ UC2]]$,
            \item for any $[[Θ ⊢ uσ' : lift UC2]]$, $[[ [uσ']uN' = iM' ]]$.
        \end{itemize}


        Let us take an arbitrary $[[Θ ⊢ uσ : lift UC]]$.
        By the soundness of the constraint merge (\cref{lemma:merge-soundness}), 
        $[[Θ ⊢ lift UC1 & lift UC2 = lift UC]]$ implies
        $[[Θ ⊢ uσ : lift UC1 ]]$ and $[[Θ ⊢ uσ : lift UC2]]$.

        Applying the induction hypothesis to $[[Θ ⊢ uσ : lift UC1]]$, we have
        $[[ [uσ]uP = iQ ]]$; applying it to $[[Θ ⊢ uσ : lift UC2]]$, we have
        $[[ [uσ]uN' = iM' ]]$.
        This way, $[[ [uσ]uN ]] = [[ [uσ]uP → [uσ]uN' ]] = [[ iQ → iM' ]] = [[ iM ]]$.

        \item \ruleref{\ottdruleUForallLabel}, then $[[uN]] = [[∀pas.uN']]$ and $[[iM]] = [[∀pas.iM']]$.
        The algorithm makes a recursive call to $[[Γ,pas ; Θ ⊨ uN' ≈u iM' ⫤ UC]]$
        returning $[[UC]]$ as the result.

        The induction hypothesis is applicable: $[[Γ,pas ; Θ ⊢ uN']]$ and $[[Γ,pas ⊢ iM']]$ hold
        by inversion, and $[[uN']]$ and $[[iM']]$ are normalized, since $[[uN]]$ and $[[iM]]$ are.
        Let us take an arbitrary $[[Θ ⊢ uσ : lift UC]]$.
        By the induction hypothesis, $[[ [uσ]uN' ]] = [[ iM' ]]$. 
        Then $[[ [uσ]uN ]] = [[ [uσ]∀pas.uN' ]] = [[ ∀pas.[uσ]uN' ]] = [[ ∀pas.iM' ]] = [[ iM ]]$.

        \item \ruleref{\ottdruleUNUVarLabel}, then $[[uN]] = [[α̂⁻]]$, $[[â⁻[Δ] ∊ Θ]]$, and $[[Δ ⊢ iM]]$.
        As the result, the algorithm returns $[[UC]] = [[ (â⁻ :≈ iM) ]]$.

        It is clear that $[[α̂⁻[Δ] ⊢ (â⁻ :≈ iM) ]]$, since $[[Δ ⊢ iM]]$, 
        meaning that $[[Θ ⊢ UC]]$.

        Let us take an arbitrary $[[uσ]]$ such that  $[[Θ ⊢ uσ : lift UC]]$.
        Since $[[UC]] = [[ (â⁻ :≈ iM) ]]$, $[[Θ ⊢ uσ : lift UC]]$ implies 
        $[[Θ(â⁻) ⊢ [uσ]â⁻ : (â⁻ :≈ iM) ]]$.
        By inversion of \ruleref{\ottdruleSATSCENEqLabel}, it  means $[[Θ(â⁻) ⊢ [uσ]â⁻ ≈ iM]]$.
        This way, $[[Θ(â⁻) ⊢ [uσ]uN ≈ iM]]$. 
        Notice that $[[uσ]]$ and $[[uN]]$ are normalized, and by \cref{lemma:norm-subst-distr}, 
        so is $[[ [uσ]uN ]]$.
        Since both sides of $[[Θ(â⁻) ⊢ [uσ]uN ≈ iM]]$ are normalized,
        by \cref{lemma:subt-equiv-algorithmization}, we have $[[ [uσ]uN = iM ]]$.

        \item The positive cases are proved symmetrically.
    \end{caseof}
\end{proof}

\begin{lemma}[Completeness of Unification] \label{lemma:unification-completeness}
    \hfill
    \begin{itemize}
        \item [$+$] For normalized $[[uP]]$ and $[[iQ]]$ such that
        $[[Γ ; Θ ⊢ uP]]$ and $[[Γ ⊢ iQ]]$, 
        for any $[[Θ ⊢ uσ]]$ such that $[[ [uσ]uP = iQ ]]$,
        there exists $[[Γ ; Θ ⊨ uP ≈u iQ ⫤ UC]]$,
        and $[[Θ ⊢ uσ : lift UC]]$.
        
        \item [$-$] For normalized $[[uN]]$ and $[[iM]]$ such that
        $[[Γ ; Θ ⊢ uN]]$ and $[[Γ ⊢ iM]]$,\\
        for any $[[Θ ⊢ uσ]]$ such that $[[ [uσ]uN = iM ]]$,
        there exists $[[Γ ; Θ ⊨ uN ≈u iM ⫤ UC]]$,
        and $[[Θ ⊢ uσ : lift UC]]$.
   \end{itemize}
\end{lemma}
\begin{proof}
    We prove it by induction on the structure of $[[uP]]$ and mutually, $[[uN]]$.
    \begin{caseof}
        \item $[[uN]] = [[α̂⁻]]$\\
            $[[Γ ; Θ ⊢ α̂⁻]]$ means that $[[ α̂⁻[Δ] ]] \in [[Θ]]$ for some $[[Δ]]$.

            Let us take an arbitrary $[[Θ ⊢ uσ]]$ such that $[[ [uσ]α̂⁻ = iM ]]$.
            $[[Θ ⊢ uσ]]$ means that $[[Δ ⊢ iM]]$.
            This way, \ruleref{\ottdruleUNUVarLabel} is applicable to infer 
            $[[Γ ; Θ ⊨ â⁻ ≈u iM ⫤ (â⁻ :≈ iM)]]$.
            $[[Θ ⊢ uσ : lift (â⁻ :≈ iM)]]$ holds by \ruleref{\ottdruleSATSCENEqLabel}. 
            
        \item $[[uN]] = [[α⁻]]$\\
            Let us take an arbitrary $[[Θ ⊢ uσ]]$ such that $[[ [uσ]α⁻ = iM ]]$.
            The latter means $[[iM = α⁻]]$.

            Then $[[ [us]α⁻ = iM ]]$ means $[[iM = α⁻]]$.
            This way, \ruleref{\ottdruleUNVarLabel} infers 
            $[[Γ; Θ ⊨ a⁻ ≈u a⁻ ⫤ ·]]$, which is rewritten as $[[Γ; Θ ⊨ uN ≈u iM ⫤ ·]]$, 
            and $[[Θ ⊢ uσ : lift ·]]$ holds trivially.

        \item $[[uN]] = [[↑uP]]$\\
            Let us take an arbitrary $[[Θ ⊢ uσ]]$ such that $[[ [uσ]↑uP = iM ]]$.
            The latter means $[[ ↑[uσ]uP = iM ]]$, i.e.
            $[[iM]] = [[↑iQ]]$ for some $[[iQ]]$ and $[[ [uσ]uP = iQ ]]$.

            Let us show that the induction hypothesis is applicable to $[[ [uσ]uP = iQ ]]$.
            Notice that $[[uP]]$ is normalized, since $[[uN]] = [[↑uP]]$ is normalized,
            $[[Γ ; Θ ⊢ uP]]$ holds by inversion of $[[Γ ; Θ ⊢ ↑uP]]$, 
            and $[[Γ ⊢ iQ]]$ holds by inversion of $[[Γ ⊢ ↑iQ]]$.

            This way, by the induction hypothesis there exists $[[UC]]$ such that
            $[[Γ ; Θ ⊨ uP ≈u iQ ⫤ UC]]$, and moreover, $[[Θ ⊢ uσ : lift UC]]$.
            
        \item $[[uN]] = [[uP → uN']]$\\
            Let us take an arbitrary $[[Θ ⊢ uσ]]$ such that $[[ [uσ](uP → uN') = iM ]]$.
            The latter means $[[ [uσ]uP → [uσ]uN' = iM ]]$, i.e.
            $[[iM]] = [[iQ → iM']]$ for some $[[iQ]]$ and $[[iM']]$, 
            such that $[[ [uσ]uP = iQ ]]$ and $[[ [uσ]uN' = iM' ]]$.

            Let us show that the induction hypothesis is applicable to 
            $[[ [uσ]uP = iQ ]]$ and to $[[ [uσ]uN' = iM' ]]$:
            \begin{itemize}
                \item $[[uP]]$ and $[[uN']]$ are normalized, since $[[uN]] = [[uP → uN']]$ is normalized
                \item $[[Γ ; Θ ⊢ uP]]$ and $[[Γ ; Θ ⊢ uN']]$ follow from the inversion of $[[Γ ; Θ ⊢ uP → uN']]$,
                \item $[[Γ ⊢ iQ]]$ and $[[Γ ⊢ iM']]$ follow from inversion of $[[Γ ⊢ iQ → iM']]$.
            \end{itemize}

            Then by the induction hypothesis, $[[Γ ; Θ ⊨ uP ≈u iQ ⫤ UC1]]$ and $[[Θ ⊢ uσ : lift UC1]]$,
            $[[Γ ; Θ ⊨ uN' ≈u iM' ⫤ UC2]]$ and $[[Θ ⊢ uσ : lift UC2]]$.
            To apply \ruleref{\ottdruleUArrowLabel} and infer the required
            $[[Γ ; Θ ⊨ uN ≈u iM ⫤ UC]]$, we need to show that
            $[[Θ ⊢ UC1 & UC2 = UC]]$ is defined and $[[Θ ⊢ uσ : lift UC]]$.
            It holds by the completeness of the unification constraint merge 
            (\cref{lemma:merge-completeness}):
            \begin{itemize}
                \item $[[Θ ⊢ UC1]]$ and $[[Θ ⊢ UC2]]$ holds by the soundness of unification (\cref{lemma:unification-soundness})
                \item $[[Θ ⊢ uσ : lift UC1]]$ and $[[Θ ⊢ uσ : lift UC2]]$ holds as noted above 
            \end{itemize}.

        \item $[[uN]] = [[∀pas.uN']]$\\
            Let us take an arbitrary $[[Θ ⊢ uσ]]$ such that $[[ [uσ]∀pas.uN' = iM ]]$.
            The latter means $[[ ∀pas.[uσ]uN' = iM ]]$, i.e.
            $[[iM]] = [[∀pas.iM']]$ for some $[[iM']]$ such that $[[ [uσ]uN' = iM' ]]$.

            Let us show that the induction hypothesis is applicable to $[[ [uσ]uN' = iM' ]]$.
            Notice that $[[uN']]$ is normalized, since $[[uN]] = [[∀pas.uN']]$ is normalized,
            $[[Γ,pas ; Θ ⊢ uN']]$ follows from inversion of $[[Γ ; Θ ⊢ ∀pas.uN']]$,
            $[[Γ,pas ⊢ iM']]$ follows from inversion of $[[Γ ⊢ ∀pas.iM']]$, and
            $[[Θ ⊢ uσ]]$ by assumption. 

            This way, by the induction hypothesis, $[[Γ,pas ; Θ ⊨ uN' ≈u iM' ⫤ UC]]$ exists and 
            moreover, $[[Θ ⊢ uσ : lift UC]]$.
            Hence, \ruleref{\ottdruleUForallLabel} is applicable to infer
            $[[Γ ; Θ ⊨ ∀pas.uN' ≈u ∀pas.iM' ⫤ UC]]$, that is $[[Γ ; Θ ⊨ uN ≈u iM ⫤ UC]]$.

        \item The positive cases are proved symmetrically.
    \end{caseof}
\end{proof}
