\lemmaDeclEquivBijection*
\begin{proof}
  We prove it by induction on $[[iP1 ≈ iP2]]$ and mutually, on $[[iN1 ≈ iN2]]$.
  Let us consider the last rule used in the derivation.
  \begin{caseof}
    \item \ruleref{\ottdruleEOneForallLabel}\\
      Then we decompose $[[iN1]]$ as $[[∀pas1.iM1]]$ and $[[iN2]]$ as $[[∀pas2.iM2]]$,
      where $[[iM1]]$ and $[[iM2]]$ do not start with $[[∀]]$-quantifiers.
      where $[[|pas1| + |pas2| > 0]]$.
      By convention, let us assume that
      $[[pas1]]$ and $[[pas2]]$ are disjoint form 
      $[[varset2]]$ and $[[varset1]]$.

      By inversion, $[[{pas1} ∩ fv iM2 = ∅]]$ and 
      $[[iM1 ≈ [μ'] iM2]]$ for some bijection
      $[[μ' : ({pas2} ∩ fv iM2) ↔ ({pas1} ∩ fv iM1)]]$.
      Then let us apply the induction hypothesis to
       $[[iM1 ≈ [μ'] iM2]]$ to obtain $[[ [μ]iM1 ≈ [μ] [μ'] iM2 ]]$ 
      inferred by the tree of the same shape as 
      $[[ iM1 ≈ [μ'] iM2 ]]$.

      Notice that $[[ [μ]iM1 ]]$ and $[[ [μ]iM2 ]]$ 
      do not start with $[[∀]]$, 
      That is $[[ [μ]∀pas1.iM1 ≈ [μ]∀pas2.iM2]]$, 
      rewritten as $[[ ∀pas1.[μ]iM1 ≈ ∀pas2.[μ]iM2]]$,
      can be inferred by \ruleref{\ottdruleEOneForallLabel}:
      \begin{enumerate}
        \item $[[{pas1}]]$ is disjoint from 
        $[[varset2 ∪ fv iM2 ⊆ fv [μ]iM2 ]]$;
        \item $[[ [μ]iM1 ≈ [μ'] [μ] iM2 ]]$
          because $[[ [μ'] [μ] iM2 = [μ] [μ'] iM2 ]]$
          (by \cref{corollary:subst-composition-commutativity}:
          $[[μ' : ({pas2} ∩ fv iM2) ↔ ({pas1} ∩ fv iM1)]]$, 
          $[[μ : varset1 ↔ varset2]]$,
          $[[varset1]]$ is disjoint from 
          $[[pas2]]$ and $[[pas1]]$; 
          $[[pas2]]$ is disjoint from $[[varset1]]$ and $[[varset2]]$)
      \end{enumerate}
      Notice that it is the same rule as the one inferring 
      $[[iN1 ≈ iN2]]$, and thus, the shapes of the trees are the same.

    \item \ruleref{\ottdruleEOneNVarLabel}\\
      Then $[[iN1]] = [[iN2]] = [[α⁻]]$, and the required
      $[[ [μ]α⁻ = [μ]α⁻ ]]$ is also inferred by
      \ruleref{\ottdruleEOneNVarLabel}, since 
      $[[ [μ]α⁻ ]]$ is a variable.
    \item \ruleref{\ottdruleEOneArrowLabel}\\
      Then we are proving 
      that $[[iP1 → iM1 ≈ iP2 → iM2]]$ implies
      $[[ [μ](iP1 → iM1) ≈ [μ](iP2 → iM2) ]]$ 
      (preserving the tree structure).

      By inversion, we have $[[iP1 ≈ iP2]]$ and $[[iM1 ≈ iM2]]$,
      and thus, by the induction hypothesis,
      $[[ [μ]iP1 ≈ [μ]iP2 ]]$ and $[[ [μ]iM1 ≈ [μ]iM2 ]]$.
      Then $[[ [μ](iP1 → iM1) ≈ [μ](iP2 → iM2) ]]$, 
      or in other words, $[[ [μ]iP1 → [μ]iM1 ≈ [μ]iP2 → [μ]iM2 ]]$,
      is inferred by the same rule---\ruleref{\ottdruleEOneArrowLabel}.
    \item \ruleref{\ottdruleEOneShiftULabel}
      This case is done by similar congruent arguments as
      the previous one.
    \item The positive cases are proved symmetrically.
    \end{caseof}
\end{proof}

\lemmaEquivFV*
\begin{proof}
  Mutual induction on $[[iN ≈ iM]]$ and $[[iP ≈ iQ]]$
  The base cases 
  (\ruleref{\ottdruleEOneNVarLabel} and \ruleref{\ottdruleEOnePVarLabel})
  are trivial.
  So are \ruleref{\ottdruleEOneShiftULabel}, 
  \ruleref{\ottdruleEOneShiftDLabel}, and
  \ruleref{\ottdruleEOneArrowLabel}, where
  the required property follows from the induction hypothesis.

  Let us consider the case when the equivalence is formed by
  \ruleref{\ottdruleEOneForallLabel}, 
  that is the equivalence has a shape 
  $[[∀pas.iN ≈ ∀pbs.iM]]$, 
  and by inversion,
  there is a bijection 
  $[[mu : ({pbs} ∩ fv iM) ↔ ({pas} ∩ fv iN)]]$
  such that $[[iN ≈ [mu] iM]]$, which 
  by the induction hypothesis means
  $[[ fv iN = fv [mu]iM ]] = [[ [mu] fv iM]] $.
  
  Let us ensure by alpha-equivalence that 
  $[[pas]]$ is disjoint from $[[fv iM]]$.
  Then $[[ (fv ∀pbs.iM) \ {pas}]] = [[fv ∀pbs.iM]]$.
  Then we apply the following chain of equalities:
  $[[fv ∀pas.iN = fv iN \ {pas}]] = 
  [[ ([mu] fv iM) \ {pas}]] = 
  [[ [mu] (fv ∀pbs.iM ∪ ({pbs} ∩ fv iM)) \ {pas}]] = 
  [[ ([mu] fv ∀pbs.iM ∪ [mu]({pbs} ∩ fv iM)) \ {pas}]] = 
  [[ ([mu] fv ∀pbs.iM) \ {pas}]] = 
  [[ (fv ∀pbs.iM) \ {pas}]] = 
  [[  fv ∀pbs.iM ]]$.

  Symmetrically, we prove the case when the equivalence is formed by
  \ruleref{\ottdruleEOneExistsLabel}.
\end{proof}

\lemmaDeclEquivTransitivity*
\begin{proof}
  We prove it by
  $\size{[[iP1 ≈ iP2]]} + \size{[[iP2 ≈ iP3]]}$
  and mutually, $\size{[[iN1 ≈ iN2]]} + \size{[[iN2 ≈ iN3]]}$, where 
  by size, we mean the size of the nodes in the corresponding inference tree.

  \begin{caseof}
    \item First, let us consider the case when either 
      $[[iN1 ≈ iN2]]$ or $[[iN2 ≈ iN3]]$ is inferred by 
      \ruleref{\ottdruleEOneForallLabel}.
      Let us decompose $[[iN1]]$, $[[iN2]]$, and $[[iN3]]$ as follows:
      $[[iN1 = ∀pas1.iM1]]$,
      $[[iN2 = ∀pas2.iM2]]$, and
      $[[iN3 = ∀pas3.iM3]]$.

      Then by inversion of $[[∀pas1.iM1 ≈ ∀pas2.iM2]]$
      (or if $[[pas1]]$ and $[[pas2]]$ are both empty, 
      by assumption) : 
      \begin{enumerate}
        \item $[[{pas1} ∩ fv iM2 = ∅]]$ and
        \item there exists a bijection on variables 
          $[[mu1 : ({pas2} ∩ fv iM2) ↔ ({pas1} ∩ fv iM1)]]$
          such that $[[iM1 ≈ [mu1] iM2]]$.
      \end{enumerate}

      Analogously, $[[∀pas1.iM1 ≈ ∀pas2.iM2]]$
      implies:
      \begin{enumerate}
        \item $[[{pas2} ∩ fv iM3 = ∅]]$ and
        \item $[[iM2 ≈ [mu2] iM3]]$ for some bijection 
          $[[mu2 : ({pas3} ∩ fv iM3) ↔ ({pas2} ∩ fv iM2)]]$.
      \end{enumerate}

      Notice that either $[[iM1 ≈ [mu1] iM2]]$
      is inferred by a proper sub-tree of $[[∀pas1.iM1 ≈ ∀pas2.iM2]]$
      or $[[iM2 ≈ [mu2] iM3]]$ is inferred by a proper sub-tree of 
      $[[∀pas2.iM2 ≈ ∀pas3.iM3]]$.

      Then by \cref{lemma:decl-equiv-bijection}, 
      $[[ [mu1]iM2 ≈ [mu1 ○ mu2] iM3]]$ and moreover, 
      $\size{[[ [mu1]iM2 ≈ [mu1 ○ mu2] iM3]]} = \size{[[iM2 ≈ [mu2] iM3]]}$.

      Since at least one of the trees inferring 
      $[[iM1 ≈ [mu1] iM2]]$ and $[[iM2 ≈ [mu2] iM3]]$
      is a proper sub-tree of the corresponding original tree,
      $\size{[[iM1 ≈ [mu1] iM2]]} + \size{[[iM2 ≈ [mu2] iM3]]} <
      \size{[[∀pas1.iM1 ≈ ∀pas2.iM2]]} + \size{[[∀pas2.iM2 ≈ ∀pas3.iM3]]}$,
      i.e., the induction hypothesis is applicable.

      By the induction hypothesis, $[[iM1 ≈ [mu1 ○ mu2] iM3]]$.
      Where $[[mu1 ○ mu2]]$ is a bijection on variables
      $[[mu1 ○ mu2 : ({pas3} ∩ fv iM3) ↔ ({pas1} ∩ fv iM1)]]$.
      Then $[[∀pas1.iM1 ≈ ∀pas3.iM3]]$ by \ruleref{\ottdruleEOneForallLabel}.

      Once this case has been considered, 
      we can assume that neither $[[iN1 ≈ iN2]]$ nor $[[iN2 ≈ iN3]]$
      is inferred by \ruleref{\ottdruleEOneForallLabel}.

    \item $[[iN1 ≈ iN2]]$ is inferred by 
      \ruleref{\ottdruleEOneNVarLabel}\\
      Then $[[iN1]] = [[iN2]] = [[α⁻]]$, and thus,  
      $[[iN1 ≈ iN3]]$ holds since $[[iN2 ≈ iN3]]$.

    \item $[[iN1 ≈ iN2]]$ is inferred by 
      \ruleref{\ottdruleEOneArrowLabel}\\
      Then $[[iN1]] = [[iP1 → iM1]]$ and $[[iN2]] = [[iP2 → iM2]]$,
      and by inversion, $[[iP1 ≈ iP2]]$ and $[[iM1 ≈ iM2]]$.

      Moreover, since $[[iN3]]$ does not start with $[[∀]]$,
      $[[iN2 ≈ iN3]]$ is also inferred by 
      \ruleref{\ottdruleEOneArrowLabel},
      which means that $[[iN3]] = [[iP3 → iM3]]$,
      $[[iP2 ≈ iP3]]$, and $[[iM2 ≈ iM3]]$.

      Then by the induction hypothesis, 
      $[[iP1 ≈ iP3]]$ and $[[iM1 ≈ iM3]]$, and thus, 
      $[[iP1 → iM1 ≈ iP3 → iM3]]$ by \ruleref{\ottdruleEOneArrowLabel}.
    \item $[[iN1 ≈ iN2]]$ is inferred by
      \ruleref{\ottdruleEOneArrowLabel}\\
      For this case, the reasoning is the same as for the previous one.
    \item The positive cases are proved symmetrically.
  \end{caseof}
\end{proof}

\lemmaWfEquiv*
\begin{proof}
  We prove it by induction on $[[iP ≈ iQ]]$ and mutually, on $[[iN ≈ iM]]$.
  Let us consider the last rule used in the derivation.
  \begin{caseof}
    \item \ruleref{\ottdruleEOneNVarLabel}, 
      that is $[[iN ≈ iM]]$ has shape $[[α⁻ ≈ α⁻]]$.\\
      Than $[[Γ ⊢ iP]] \iff [[Γ ⊢ iQ]]$ is rewritten as $[[Γ ⊢ α⁻]] \iff [[Γ ⊢ α⁻]]$,
      which holds trivially.
    \item \ruleref{\ottdruleEOneShiftULabel},
      that is $[[iN ≈ iM]]$ has shape $[[↑iP ≈ ↑iQ]]$.\\
      By inversion, $[[iP ≈ iQ]]$, and by the induction hypothesis,
      $[[Γ ⊢ iP]] \iff [[Γ ⊢ iQ]]$. 
      Also notice that $[[Γ ⊢ ↑iP]] \iff [[Γ ⊢ iP]]$ 
      and $[[Γ ⊢ ↑iQ]] \iff [[Γ ⊢ iQ]]$ by inversion and \ruleref{\ottdruleWFTShiftULabel}.
      This way, $[[Γ ⊢ ↑iP]] \iff [[Γ ⊢ iP]] \iff [[Γ ⊢ iQ]] \iff [[Γ ⊢ ↑iQ]]$.
    \item \ruleref{\ottdruleEOneArrowLabel},
      that is $[[iN ≈ iM]]$ has shape $[[iP → iN' ≈ iQ → iM']]$.\\
      Then by inversion, $[[iP ≈ iQ]]$ and $[[iN' ≈ iM']]$, 
      and by the induction hypothesis, $[[Γ ⊢ iP]] \iff [[Γ ⊢ iQ]]$ and $[[Γ ⊢ iN']] \iff [[Γ ⊢ iM']]$.
      \begin{align*}
        [[Γ ⊢ iP → iN']]  &\iff [[Γ ⊢ iP]] \text{ and } [[Γ ⊢ iN']] 
                          && \text{by inversion and \ruleref{\ottdruleWFTArrowLabel}}\\
                          &\iff [[Γ ⊢ iQ]] \text{ and } [[Γ ⊢ iM']]
                          && \text{as noted above}\\
                          &\iff [[Γ ⊢ iQ → iM']]
                          && \text{by \ruleref{\ottdruleWFTArrowLabel} and inversion}\\
      \end{align*}
    \item \ruleref{\ottdruleEOneForallLabel},
      that is $[[iN ≈ iM]]$ has shape $[[∀pas.iN' ≈ ∀pbs.iM']]$.\\
      By inversion, $[[∀pas.iN' ≈ ∀pbs.iM']]$ means that
      $[[{pas} ∩ fv iM = ∅]]$ and 
      that there exists a bijection on variables 
      $[[mu : ({pbs} ∩ fv iM') ↔ ({pas} ∩ fv iN')]]$
      such that $[[iN' ≈ [mu] iM']]$.

      By inversion and \ruleref{\ottdruleWFTForallLabel},
      $[[Γ ⊢ ∀pas.iN']]$ is equivalent to $[[Γ, pas ⊢ iN']]$,
      and by \cref{lemma:wf-ctxt-equiv}, it is equivalent to 
      $[[Γ,  ({pas} ∩ fv iN') ⊢ iN']]$,
      which, by the induction hypothesis, is equivalent to
      $[[Γ,  ({pas} ∩ fv iN') ⊢ [mu]iM']]$.

      Analogously, $[[Γ ⊢ ∀pbs.iM']]$ is equivalent to
      $[[Γ, ( {pbs} ∩ fv iM') ⊢ iM']]$.
      By \cref{lemma:wf-subst}, it implies 
      $[[Γ,  ({pas} ∩ fv iM') ⊢ [mu]iM']]$. And vice versa, 
      $[[Γ,  ({pas} ∩ fv iM') ⊢ [mu]iM']]$ implies  
      $[[Γ,  ({pbs} ∩ fv iM') ⊢ [mu-1][mu]iM']]$.
 
      This way, both $[[Γ ⊢ ∀pas.iN']]$ and $[[Γ ⊢ ∀pbs.iM']]$ are equivalent to
      $[[Γ,  ({pas} ∩ fv iN') ⊢ [mu]iM']]$. 
    \item For the cases of the positive types, the proofs are symmetric.
  \end{caseof}
\end{proof}

\lemmaEquivSoundness*
\begin{proof}
  We prove it by mutual induction on $[[iP ≈ iQ]]$ and $[[iN ≈ iM]]$.
  \begin{caseof}
    \item $[[a⁻ ≈ a⁻]]$\\
      Then $[[Γ ⊢ a⁻ ≤ a⁻]]$ by \ruleref{\ottdruleDOneNVarLabel},
      which immediately implies $[[Γ ⊢ a⁻ ≈ a⁻]]$ by \ruleref{\ottdruleDOneNDefLabel}.

    \item $[[↑iP ≈ ↑iQ]]$\\
      Then by inversion of \ruleref{\ottdruleDOneShiftULabel},
      $[[iP ≈ iQ]]$, and from the induction hypothesis, $[[Γ ⊢ iP ≈ iQ]]$,
      and (by symmetry) $[[Γ ⊢ iQ ≈ iP]]$.

      When \ruleref{\ottdruleDOneShiftULabel} is applied to $[[Γ ⊢ iP ≈ iQ]]$,
      it gives us $[[Γ ⊢ ↑iP ≤ ↑iQ]]$; when it is applied to $[[Γ ⊢ iQ ≈ iP]]$,
      we obtain $[[Γ ⊢ ↑iQ ≤ ↑iP]]$. Together, it implies $[[Γ ⊢ ↑iP ≈ ↑iQ]]$.

    \item $[[iP → iN ≈ iQ → iM]]$\\
      Then by inversion of \ruleref{\ottdruleDOneArrowLabel},
      $[[iP ≈ iQ]]$ and $[[iN ≈ iM]]$. By the induction hypothesis,
      $[[Γ ⊢ iP ≈ iQ]]$ and $[[Γ ⊢ iN ≈ iM]]$, which means by inversion:
      \begin{enumerate*}
        \item[(i)] $[[Γ ⊢ iP ≥ iQ]]$,
        \item[(ii)] $[[Γ ⊢ iQ ≥ iP]]$,
        \item[(iii)] $[[Γ ⊢ iN ≤ iM]]$,
        \item[(iv)]  $[[Γ ⊢ iM ≤ iN]]$.
      \end{enumerate*}
      Applying \ruleref{\ottdruleDOneArrowLabel} to (i) and (iii), we obtain
      $[[Γ ⊢ iP → iN ≤ iQ → iM]]$; applying it to (ii) and (iv), we have $[[Γ ⊢
      iQ → iM ≤ iP → iN]]$. Together, it implies $[[Γ ⊢ iP → iN ≈ iQ → iM]]$.
    \item $[[∀pas.iN ≈ ∀pbs.iM]]$\\
      Then by inversion, there exists bijection $[[mu : ({pbs} ∩ fv iM) ↔ ({pas}
      ∩ fv iN)]]$, such that $[[iN ≈ [mu] iM]]$. By the induction hypothesis,
      $[[Γ, pas ⊢ iN ≈ [mu] iM]]$. From \cref{corollary:subst-pres-equiv} and
      the fact that $[[mu]]$ is bijective, we also have
      $[[Γ, pbs ⊢ [mu-1]iN ≈ iM]]$.

      Let us construct a substitution $[[{pas} ⊢ iPs/pbs : {pbs}]]$ by
      extending $[[mu]]$ with arbitrary positive types on $[[{pbs} \ fv iM]]$.

      Notice that $[[ [mu]iM ]] = [[ [iPs/pbs]iM ]]$, and therefore,
      $[[Γ, pas ⊢ iN ≈ [mu] iM]]$ implies $[[Γ, pas ⊢ [iPs/pbs]iM ≤ iN]]$. Then by
      \ruleref{\ottdruleDOneForallLabel}, $[[Γ ⊢ ∀pbs.iM ≤ ∀pas.iN]]$.

      Analogously, we construct the substitution from $[[mu-1]]$, and use it to
      instantiate $[[pas]]$ in the application of
      \ruleref{\ottdruleDOneForallLabel} to infer $[[Γ ⊢ ∀pas.iN ≤ ∀pbs.iM]]$.

      This way, $[[Γ ⊢ ∀pbs.iM ≤ ∀pas.iN]]$ and $[[Γ ⊢ ∀pas.iN ≤ ∀pbs.iM]]$
      gives us $[[Γ ⊢ ∀pbs.iM ≈ ∀pas.iN]]$.

    \item For the cases of the positive types, the proofs are symmetric.
  \end{caseof}
\end{proof}

\lemmaSubtIndDisjSubst*
\begin{proof}
  Proof by induciton on $[[Γ ⊢ iN]]$ (and mutually on $[[Γ ⊢ iP]]$).
  \begin{caseof}
    \item $[[iN]] = [[α⁻]]$\\
      Then $[[Γ ⊢ [σ1]iN ≤ [σ2]iN]]$ is rewritten as $[[Γ ⊢ [σ1]α⁻ ≤ [σ2]α⁻]]$.
      Let us consider the following cases:
      \begin{caseof}
      \item $[[α⁻ ∉ Γ1]]$ and $[[α⁻ ∉ Γ2]]$ \label{case:var-not-in-ctxts}\\
        Then $[[Γ ⊢ σi ≈ id : {α⁻}]]$ holds immediately,
        since $[[ [σi] α⁻]] = [[ [id] α⁻]] = [[α⁻]]$ and
        $[[Γ ⊢ α⁻ ≈ α⁻]]$.
      \item $[[α⁻ ∊ Γ1]]$ and $[[α⁻ ∊ Γ2]]$\\
        This case is not possible by assumption: $[[Γ1 ∩ Γ2= ∅]]$.
      \item $[[α⁻ ∊ Γ1]]$ and $[[α⁻ ∉ Γ2]]$\\
        Then we have $[[Γ ⊢ [σ1]α⁻ ≤ α⁻]]$,
        which by \cref{corollary:vars-no-proper-subtypes} means $[[Γ ⊢ [σ1]α⁻ ≈ α⁻]]$,
        and hence, $[[Γ ⊢ σ1 ≈ id : {α⁻}]]$.

        $[[Γ ⊢ σ2 ≈ id : {α⁻}]]$ holds since $[[ [σ2]α⁻ ]] = [[α⁻]]$,
        similarly to \cref{case:var-not-in-ctxts}.

      \item $[[α⁻ ∉ Γ1]]$ and $[[α⁻ ∊ Γ2]]$\\
        Then we have $[[Γ ⊢ α⁻ ≤ [σ2]α⁻]]$,
        which by \cref{corollary:vars-no-proper-subtypes} means $[[Γ ⊢ α⁻ ≈ [σ2]α⁻]]$,
        and hence, $[[Γ ⊢ σ2 ≈ id : {α⁻}]]$.

        $[[Γ ⊢ σ1 ≈ id : {α⁻}]]$ holds since $[[ [σ1]α⁻ ]] = [[α⁻]]$,
        similarly to \cref{case:var-not-in-ctxts}.
      \end{caseof}
  \item $[[iN]] = [[∀pas.iM]]$\\
    Then by inversion, $[[Γ, pas ⊢ iM]]$.
    $[[Γ ⊢ [σ1]iN ≤ [σ2]iN]]$ is rewritten as $[[Γ ⊢ [σ1]∀pas.iM ≤ [σ2]∀pas.iM]]$.
    By the congruence of substitution and by the inversion of
    \ruleref{\ottdruleDOneForallLabel}, $[[Γ, pas ⊢ [iQs/pas][σ1]iM ≤ [σ2]iM]]$,
    where $[[Γ, pas ⊢ iQi]]$.
    Let us denote the (Kleisli) composition of $[[σ1]]$ and $[[iQs/pas]]$ as
    $[[σ1']]$, noting that $[[Γ, pas ⊢ σ1' : Γ1, pas]]$,
    and $[[(Γ1, pas) ∩ Γ2 = ∅]]$.

    Let us apply the induction hypothesis to $[[iM]]$ and the
    substitutions $[[σ1']]$ and $[[σ2]]$ with
    $[[Γ, pas ⊢ [σ1']iM ≤ [σ2]iM]]$ to obtain:
    \begin{align}
      [[Γ, pas ⊢ σ1' ≈ id :  fv iM]] \label{fact:subs-proper-sub:forall-ih}\\
      [[Γ, pas ⊢ σ2 ≈ id :  fv iM]]  \label{fact:subs-proper-sub:forall-ih2}
    \end{align}

    Then $[[Γ ⊢ σ2 ≈ id :  fv ∀pas.iM]]$ holds by strengthening of
    \ref{fact:subs-proper-sub:forall-ih2}:
    for any $[[β±]] \in [[fv ∀pas.iM]] = [[fv iM \ {pas}]]$,
    $[[Γ, pas ⊢ [σ2]β± ≈ β±]]$ is strengthened to $[[Γ ⊢ [σ2]β± ≈ β±]]$, because
    $[[fv [σ2]β±]] = [[fv β±]] = \{[[β±]]\} \subseteq [[Γ]]$.

    To show that $[[Γ ⊢ σ1 ≈ id :  fv ∀pas.iM]]$, let us take an arbitrary
    $[[β±]] \in [[fv ∀pas.iM]] = [[fv iM \ {pas}]]$.
    \begin{align*}
      [[β±]] &= [[ [id]β± ]]
             && \text{by definition of $[[id]]$}\\
             &\eqDOne [[ [σ1']β± ]]
             && \text{by \ref{fact:subs-proper-sub:forall-ih}}\\
             &= [[ [iQs/pas][σ1]β±]]
             && \text{by definition of $[[σ1']]$}\\
             &= [[ [σ1]β± ]]
             && \text{because $[[{pas} ∩ fv [σ1]β±]] \subseteq [[{pas} ∩ Γ]] = \emptyset$}
    \end{align*}
    This way, $[[Γ ⊢ [σ1]β± ≈ β±]]$ for any $[[β±]] \in [[fv ∀pas.iM]]$ and thus,
    $[[Γ ⊢ σ1 ≈ id :  fv ∀pas.iM]]$.

  \item $[[iN]] = [[iP → iM]]$\\
    Then by inversion, $[[Γ ⊢ iP]]$ and $[[Γ ⊢ iM]]$.
    $[[Γ ⊢ [σ1]iN ≤ [σ2]iN]]$ is rewritten as
    $[[Γ ⊢ [σ1](iP → iM) ≤ [σ2](iP → iM)]]$,
    then by congruence of substitution,
    $[[Γ ⊢ [σ1]iP → [σ1]iM ≤ [σ2]iP → [σ2]iM]]$,
    then by inversion
    $[[Γ ⊢ [σ1]iP ≥ [σ2]iP]]$
    and
    $[[Γ ⊢ [σ1]iM ≤ [σ2]iM]]$.

    Applying the induction hypothesis to $[[Γ ⊢ [σ1]iP ≥ [σ2]iP]]$
    and to $[[Γ ⊢ [σ1]iM ≤ [σ2]iM]]$, we obtain (respectively):
    \begin{align}
      &[[Γ ⊢ σi ≈ id :  fv iP]] \label{fact:subs-proper-sub:arrow-ih1}\\
      &[[Γ ⊢ σi ≈ id :  fv iM]] \label{fact:subs-proper-sub:arrow-ih2}
    \end{align}

    Noting that $[[fv (iP → iM)]] = [[fv iP ∪ fv iM]]$,
    we combine
    \cref{fact:subs-proper-sub:arrow-ih1,fact:subs-proper-sub:arrow-ih2}
    to conclude:
    $[[Γ ⊢ σi ≈ id :  fv (iP → iM)]]$.

  \item $[[iN]] = [[↑iP]]$\\
    Then by inversion, $[[Γ ⊢ iP]]$.
    $[[Γ ⊢ [σ1]iN ≤ [σ2]iN]]$ is rewritten as
    $[[Γ ⊢ [σ1]↑iP ≤ [σ2]↑iP]]$,
    then by congruence of substitution and by inversion,
    $[[Γ ⊢ [σ1]iP ≥ [σ2]iP]]$

    Applying the induction hypothesis to $[[Γ ⊢ [σ1]iP ≥ [σ2]iP]]$, we obtain
    $[[Γ ⊢ σi ≈ id :  fv iP]]$. Since $[[fv ↑iP]] = [[fv iP]]$, we can
    conclude: $[[Γ ⊢ σi ≈ id :  fv ↑iP]]$.
  \item The positive cases are proved symmetrically.
  \end{caseof}
\end{proof}

\corollarySubstProperSubt*


\lemmaMutualSubstSubtyping*
\begin{proof}
  \hfill
  \begin{itemize}
  \item[$+$]
    Applying $[[σ2]]$ to both sides of
    $[[Γ ⊢ [σ1] iP ≥ iQ]]$ (by \cref{lemma:subst-pres-subt}),
    we have: $[[Γ ⊢ [σ2 ○ σ1] iP ≥ [σ2]iQ]]$.
    Composing it with $[[Γ ⊢ [σ2] iQ ≥ iP]]$ by transitivity 
    (\cref{lemma:subtyping-transitivity}),
    we have $[[Γ ⊢ [σ2 ○ σ1] iP ≥ iP]]$.
    Then by \cref{corollary:subst-proper-subt},
    $[[Γ ⊢ σ2 ○ σ1 ≈ id :  fv iP]]$.
    By a symmetric argument, we also have:
    $[[Γ ⊢ σ1 ○ σ2 ≈ id :  fv iQ]]$.

    Now, we prove that
    $[[Γ ⊢ σ2 ○ σ1 ≈ id :  fv iP]]$ and
    $[[Γ ⊢ σ1 ○ σ2 ≈ id :  fv iQ]]$
    implies that $[[σ1]]$ and $[[σ1]]$
    are (equivalent to) mutually inverse bijections.

    To do so, it suffices to prove that
    \begin{enumerate}
    \item[(i)] for any $[[α± ∊ fv iP]]$ there exists $[[β± ∊ fv iQ]]$
        such that $[[ Γ ⊢ [σ1] α± ≈ β± ]]$ and
        $[[ Γ ⊢ [σ2] β± ≈ α± ]]$; and
    \item[(ii)] for any $[[β± ∊ fv iQ]]$ there exists $[[α± ∊ fv iP]]$
        such that $[[ Γ ⊢ [σ2] β± ≈ α± ]]$ and
        $[[ Γ ⊢ [σ1] α± ≈ β± ]]$.
    \end{enumerate}
    Then these correspondences between $[[fv iP]]$ and
    $[[fv iQ]]$ are mutually inverse functions,
    since for any $[[β±]]$ there can be at most one $[[α±]]$
    such that $[[ Γ ⊢ [σ2] β± ≈ α± ]]$ (and vice versa).

    \begin{enumerate}
    \item[(i)] Let us take $[[α± ∊ fv iP]]$.
      \begin{enumerate}
      \item if $[[α±]]$ is positive ($[[α± = α⁺]]$),
        from $[[ Γ ⊢ [σ2][σ1]α⁺ ≈ α⁺ ]]$,
        by \cref{corollary:vars-no-proper-subtypes},
        we have
        $[[ [σ2][σ1]α⁺ = ∃nbs.α⁺ ]]$.

        What shape can $[[ [σ1]α⁺ ]]$ have? It cannot be $[[∃nas.↓iN]]$ (for
        potentially empty $[[nas]]$), because the outer constructor $\downarrow$
        would remain after the substitution $[[σ2]]$, whereas $[[∃nbs.α⁺]]$ does
        not have $[[↓]]$. The only case left is $[[ [σ1]α⁺ = ∃nas.γ⁺ ]]$.

        Notice that $[[Γ ⊢ ∃nas.γ⁺ ≈ γ⁺]]$, meaning that $[[Γ ⊢ [σ1]α⁺ ≈ γ⁺]]$.
        Also notice that $[[ [σ2]∃nas.γ⁺ = ∃nbs.α⁺ ]]$ implies
        $[[Γ ⊢ [σ2]γ⁺ ≈ α⁺]]$.

      \item if $[[α±]]$ is negative ($[[α± = α⁻]]$) from $[[ Γ ⊢ [σ2][σ1]α⁻ ≈ α⁻
        ]]$, by \cref{corollary:vars-no-proper-subtypes}, we have
        $[[ [σ2][σ1]α⁻ = ∀pbs.α⁻ ]]$.

        What shape can $[[ [σ1]α⁻ ]]$ have? It cannot be $[[∀pas.↑iP]]$
        nor $[[∀pas.iP → iM]]$ (for potentially empty $[[pas]]$),
        because the outer constructor ($[[→]]$ or $[[↑]]$), remaining
        after the substitution $[[σ2]]$, is however absent in the resulting
        $[[∀pbs.α⁻]]$. Hence, the only case left is $[[ [σ1]α⁻ = ∀pas.γ⁻ ]]$
        Notice that $[[Γ ⊢ γ⁻ ≈ ∀pas.γ⁻]]$, meaning that $[[Γ ⊢ [σ1]α⁻ ≈ γ⁻]]$.
        Also notice that $[[ [σ2]∀pas.γ⁻ = ∀pbs.α⁻ ]]$ implies
        $[[Γ ⊢ [σ2]γ⁻ ≈ α⁻]]$.
      \end{enumerate}
    \item[(ii)] The proof is symmetric:
      We swap $[[iP]]$ and $[[iQ]]$,
      $[[σ1]]$ and $[[σ2]]$,
      and exploit $[[ Γ ⊢ [σ1][σ2]α± ≈ α± ]]$ instead of
      $[[ Γ ⊢ [σ2][σ1]α± ≈ α± ]]$.

    \end{enumerate}

  \item[$-$] The proof is symmetric to the positive case.
  \end{itemize}
\end{proof}

\lemmaEquivSubstOnSameTerm*
\begin{proof}
  We prove it by induction on $[[iP]]$ (and mutually on $[[iN]]$).
  \begin{caseof}
    \item $[[iN = α⁻]]$\\
      Then since by inversion, $[[α⁻ ∊ Γ]]$, 
      $[[Γ' ⊢ [σ1]α⁻ ≈ [σ2]α⁻]]$ holds by definition of $[[Γ' ⊢ σ1 ≈ σ2 : Γ]]$.
    \item $[[iN = ↑iP]]$\\
      Then by inversion, $[[Γ ⊢ iP]]$.
      By the induction hypothesis, $[[Γ' ⊢ [σ1]iP ≈ [σ2]iP]]$, 
      Then by \ruleref{\ottdruleDOneShiftULabel}, 
      $[[Γ' ⊢ ↑[σ1]iP ≤ ↑[σ2]iP]]$, and symmetrically, $[[Γ' ⊢ ↑[σ2]iP ≤ ↑[σ1]iP]]$,
      together meaning that $[[Γ' ⊢ ↑[σ1]iP ≈ ↑[σ2]iP]]$,
      or equivalently, $[[Γ' ⊢ [σ1]↑iP ≈ [σ2]↑iP]]$.
    \item $[[iN = iP → iM]]$\\
      Then by inversion, $[[Γ ⊢ iP]]$ and $[[Γ ⊢ iM]]$.
      By the induction hypothesis, $[[Γ' ⊢ [σ1]iP ≈ [σ2]iP]]$ and
      $[[Γ' ⊢ [σ1]iM ≈ [σ2]iM]]$,
      that is $[[Γ' ⊢ [σ1]iP ≥ [σ2]iP]]$, $[[Γ' ⊢ [σ2]iP ≥ [σ1]iP]]$,
      $[[Γ' ⊢ [σ1]iM ≤ [σ2]iM]]$, and $[[Γ' ⊢ [σ2]iM ≤ [σ1]iM]]$.
      Then by \ruleref{\ottdruleDOneArrowLabel}, $[[Γ' ⊢ [σ1]iP → [σ1]iM ≤ [σ2]iP → [σ2]iM]]$, 
      and again by \ruleref{\ottdruleDOneArrowLabel}, $[[Γ' ⊢ [σ2]iP → [σ2]iM ≤ [σ1]iP → [σ1]iM]]$.
      This way, $[[Γ' ⊢ [σ1]iP → [σ1]iM ≈ [σ2]iP → [σ2]iM]]$,
      or equivalently, $[[Γ' ⊢ [σ1](iP → iM) ≈ [σ2](iP → iM)]]$.
    \item $[[iN = ∀pas.iM]]$
      We can assume that $[[pas]]$ is disjoint from $[[Γ]]$ and $[[Γ']]$.
      By inversion, $[[Γ ⊢ ∀pas.iM]]$ implies $[[Γ, pas ⊢ iM]]$.
      Notice that $[[Γ' ⊢ σi : Γ]]$ and 
      $[[Γ' ⊢ σ1 ≈ σ2 : Γ]]$
      can be extended to 
      $[[Γ', pas ⊢ σi : Γ, pas]]$
      and 
      $[[Γ', pas ⊢ σ1 ≈ σ2 : Γ, pas]]$
      by \cref{lemma:subst-domain-weakening}.
      Then by the induction hypothesis,
      $[[Γ', pas ⊢ [σ1]iM ≈ [σ2]iM]]$,
      meaning by inversion that
      $[[Γ', pas ⊢ [σ1]iM ≤ [σ2]iM]]$ and 
      $[[Γ', pas ⊢ [σ2]iM ≤ [σ1]iM]]$.

      To infer
      $[[Γ' ⊢ ∀pas.[σ1]iM ≤ ∀pas.[σ2]iM]]$,
      we apply \ruleref{\ottdruleDOneForallLabel}
      with the substitution $[[Γ', pas ⊢ id :{pas}]]$, 
      noting that $[[Γ', pas ⊢ [id][σ1]iM ≤ [σ2]iM ]]$
      holds since $[[Γ', pas ⊢ [σ1]iM ≤ [σ2]iM ]]$, 
      as noted above. 

      Symmetrically, we infer
      $[[Γ' ⊢ ∀pas.[σ2]iM ≤ ∀pas.[σ1]iM]]$,
      which together with
      $[[Γ' ⊢ ∀pas.[σ1]iM ≤ ∀pas.[σ2]iM]]$
      means
      $[[Γ' ⊢ ∀pas.[σ1]iM ≈ ∀pas.[σ2]iM]]$,
      or equivalently, 
      $[[Γ' ⊢ [σ1]∀pas.iM ≈ [σ2]∀pas.iM]]$.

    \item The positive cases are proved symmetrically.
  \end{caseof}
\end{proof}

\lemmaPolyTypesEquivalence*
\begin{proof}
    \hfill
  \begin{itemize}
    \item[$-$]
      First, by $\alpha$-conversion, we ensure $[[{pas} ∩ fv iM = ∅]]$ and $[[{pbs} ∩ fv iN = ∅]]$.
      By inversion, $[[Γ ⊢ ∀pas.iN ≈ ∀pbs.iM ]]$ implies 
      \begin{enumerate} 
        \item $[[Γ,pbs ⊢ [σ1]iN ≤ iM]]$ for $[[ Γ,pbs ⊢ σ1 :{pas} ]]$ and 
        \item $[[Γ,pas ⊢ [σ2]iM ≤ iN]]$ for $[[ Γ,pas ⊢ σ2 : {pbs} ]]$.
      \end{enumerate}
      To apply \cref{lemma:mutual-subst-subtyping}, we weaken 
      and rearrange the contexts, and extend the substitutions to act as identity
      outside of their initial domain:
      \begin{enumerate} 
        \item $[[Γ, {pas}, {pbs} ⊢ [σ1]iN ≤ iM]]$ for $[[ Γ, {pas}, {pbs} ⊢ σ1 : Γ, {pas}, {pbs} ]]$ and 
        \item $[[Γ, {pas}, {pbs} ⊢ [σ2]iM ≤ iN]]$ for $[[ Γ, {pas}, {pbs} ⊢ σ2 : Γ, {pas}, {pbs} ]]$.
      \end{enumerate}
      Then from \cref{lemma:mutual-subst-subtyping}, 
      there exists a bijection $[[μ : fv iM ↔ fv iN]]$ such that 
      $[[Γ, {pas}, {pbs} ⊢ σ2 ≈ Sub μ :  fv iM]]$ and 
      $[[Γ, {pas}, {pbs} ⊢ σ1 ≈ Sub μ-1 :  fv iN]]$. 

      Let us show that $[[Sub μ|{pbs}]]$ is the appropriate candidate.

      First, we show that if we restrict the domain of $[[μ]]$ to 
      $[[pbs]]$, its range will be contained in $[[pas]]$.

      Let us take $[[γ⁺ ∊ {pbs} ∩ fv iM]]$ and 
      assume $[[ [μ]γ⁺]] \notin [[pas]]$.
      Then since $[[ Γ,pbs ⊢ σ1 :{pas} ]]$, 
      $[[σ1]]$ acts as identity outside of $[[pas]]$, i.e.
      $[[ [σ1][Sub μ]γ⁺ = [Sub μ]γ⁺ ]]$ (notice that $[[γ⁺]]$ is in the domain of $[[μ]]$).
      Since
      $[[Γ, {pas}, {pbs} ⊢ σ1 ≈ Sub μ-1 :  fv iN]]$, 
      application of $[[σ1]]$ to $[[ [μ]γ⁺ ]] \in [[fv iN]]$
      is equivalent to application of $[[Sub μ-1]]$, then 
      $[[ Γ, {pas}, {pbs} ⊢ [Sub μ-1][Sub μ]γ⁺ ≈ [Sub μ]γ⁺ ]]$, i.e.
      $[[Γ, {pas}, {pbs} ⊢ γ⁺ ≈ [Sub μ]γ⁺]]$, 
      which means $[[γ⁺ ∊ fv [Sub μ]γ⁺]] \subseteq [[fv iN]]$.
      By assumption, $[[γ⁺ ∊ {pbs} ∩ fv iM]]$, i.e. $[[{pbs} ∩ fv iN]] \neq \emptyset$, hence contradiction.

      Second, 
      we will show $[[ Γ, pas ⊢ iN ≈ [Sub μ|{pbs}] iM ]]$.

      Since $[[ Γ,pas ⊢ σ2 : {pbs} ]]$ and 
      $[[Γ, {pas}, {pbs} ⊢ σ2 ≈ Sub μ :  fv iM]]$, 
      we have
      $[[Γ, {pas}, {pbs} ⊢ σ2 ≈ Sub μ|{pbs} :  fv iM]]$:
      for any $[[α± ∊ fv iM \ {pbs}]]$, $[[ [σ2]α± = α± ]]$
      since $[[ Γ,pas ⊢ σ2 : {pbs} ]]$, and
      $[[ [Sub μ|{pbs}]α± = α± ]]$ by definition of substitution restriction;
      for $[[β⁺ ∊ {pbs}]]$, $[[ [Sub μ|{pbs}]β⁺ = [μ]β⁺ ]]$,
      and thus, $[[Γ, {pas}, {pbs} ⊢ [σ2]β⁺ ≈ [Sub μ]β⁺ ]]$
      can be rewritten to $[[Γ, {pas}, {pbs} ⊢ [σ2]β⁺ ≈ [Sub μ|{pbs}]β⁺ ]]$.

      By \cref{lemma:equiv-subst-on-same-term},
      $[[Γ, {pas}, {pbs} ⊢ σ2 ≈ Sub μ|{pbs} :  fv iM]]$ implies
      $[[Γ, {pas}, {pbs} ⊢ [σ2]iM ≈ [Sub μ|{pbs}]iM]]$.
      By similar reasoning, $[[Γ, {pas}, {pbs} ⊢ [σ1]iN ≈ [Sub μ-1|{pas}]iN]]$.

      This way, by transitivity of subtyping (\cref{lemma:subtyping-transitivity}),
      \begin{align} 
        [[Γ, {pas}, {pbs} ⊢ [Sub μ-1|{pas}]iN ≤ iM]] \label{fact:mu-inv-n-sub-m}\\
        [[Γ, {pas}, {pbs} ⊢ [Sub μ|{pbs}]iM ≤ iN]] \label{fact:mu-m-subt-n}
      \end{align}

      By applying $[[Sub μ|{pbs}]]$ to both sides of \ref{fact:mu-inv-n-sub-m} 
      (\cref{lemma:subst-pres-subt}), we have
      $[[Γ, {pas}, {pbs} ⊢ [Sub μ|{pbs}][Sub μ-1|{pas}]iN ≤ [Sub μ|{pbs}]iM]]$. 
      By contracting $[[μ-1|_{pas} ○ μ|_{pbs}]] = [[μ|_{pbs}-1 ○ μ|_{pbs}]]$
      (notice that $[[fv iN ∩ {pbs} = ∅]]$), 
      we have $[[Γ, {pas}, {pbs} ⊢ iN ≤ [Sub μ|{pbs}]iM]]$, which together with \ref{fact:mu-m-subt-n}
      means $[[Γ, {pas}, {pbs} ⊢ iN ≈ [Sub μ|{pbs}]iM]]$, and by strengthening, $[[Γ,pas⊢ iN ≈ [Sub μ|{pbs}]iM]]$.
      % Symmetrically, $[[Γ,pbs ⊢ iM ≈ [Sub μ|_{pbs}-1]iN]]$.
    \item[$+$] The proof is symmetric to the proof of the negative case.
  \end{itemize}

\end{proof}


\lemmaEquivCompleteness*
\begin{proof}
  \begin{itemize}
    \item[$-$] 
    Induction on the sum of sizes of  $[[iN]]$ and $[[iM]]$. 
    By inversion, $[[Γ ⊢ iN ≈ iM]]$ means $[[Γ ⊢ iN ≤ iM]]$ and $[[Γ ⊢ iM ≤ iN ]]$.
    Let us consider the last rule that forms $[[Γ ⊢ iN ≤ iM]]$:
    \begin{caseof}
      \item \ruleref{\ottdruleDOneNVarLabel} i.e. $[[Γ ⊢ iN ≤ iM]]$ is of the form $[[Γ ⊢ α⁻ ≤ α⁻]]$\\
      Then $[[iN ≈ iM]]$ (i.e. $[[α⁻ ≈ α⁻]]$) holds immediately by \ruleref{\ottdruleEOneNVarLabel}.

      \item \ruleref{\ottdruleDOneShiftULabel} i.e. 
      $[[Γ ⊢ iN ≤ iM]]$ is of the form $[[Γ ⊢ ↑iP ≤ ↑iQ]]$\\
      Then by inversion, $[[Γ ⊢ iP ≈ iQ]]$, 
      and by induction hypothesis, $[[iP ≈ iQ]]$.
      Then $[[iN ≈ iM]]$ (i.e. $[[↑iP ≈ ↑iQ]]$) holds 
      by \ruleref{\ottdruleEOneShiftULabel}.

      \item \ruleref{\ottdruleDOneArrowLabel} i.e. $[[Γ ⊢ iN ≤ iM]]$ is of the form $[[Γ ⊢ iP → iN' ≤ iQ → iM']]$\\
      Then by inversion, $[[Γ ⊢ iP ≥ iQ]]$ and $[[Γ ⊢ iN' ≤ iM']]$.
      Notice that $[[Γ ⊢ iM ≤ iN]]$ is of the form $[[Γ ⊢ iQ → iM' ≤ iP → iN']]$, 
      which by inversion means $[[Γ ⊢ iQ ≥ iP]]$ and $[[Γ ⊢ iM' ≤ iN']]$.

      This way, $[[Γ ⊢ iQ ≈ iP]]$ and $[[Γ ⊢ iM' ≈ iN']]$. 
      Then by induction hypothesis, $[[iQ ≈ iP]]$ and $[[iM' ≈ iN']]$.
      Then $[[iN ≈ iM]]$ (i.e. $[[iP → iN' ≈ iQ → iM']]$) holds by \ruleref{\ottdruleEOneArrowLabel}.

      \item \ruleref{\ottdruleDOneForallLabel} i.e. $[[Γ ⊢ iN ≤ iM]]$ is of the form $[[Γ ⊢ ∀pas.iN' ≤ ∀pbs.iM']]$\\
      Then by \cref{lemma:poly-types-equivalence}, $[[Γ ⊢ ∀pas.iN' ≈ ∀pbs.iM']]$ means that 
      there exists a bijection $[[μ : {pbs} ∩ fv iM' ↔ {pas} ∩ fv iN']]$ such that  
      $[[Γ,pas ⊢ [Sub μ]iM' ≈ iN']]$. 
      
      Notice that the application of bijection $[[μ]]$ to $[[iM']]$ does
      not change its size (which is less than the size of $[[iM]]$), hence the induction hypothesis applies.
      This way, $[[ [Sub μ]iM' ≈ iN']]$ (and by symmetry, $[[iN' ≈ [Sub μ]iM']]$) holds by induction. 
      Then we apply \ruleref{\ottdruleEOneForallLabel} to get $[[∀pas.iN' ≈ ∀pbs.iM']]$, i.e. $[[iN ≈ iM]]$.
    \end{caseof}
      
\item[$+$] The proof is symmetric to the proof of the negative case.
  \end{itemize}
\end{proof}

