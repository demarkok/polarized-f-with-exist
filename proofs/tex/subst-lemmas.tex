\begin{lemma}[Substitution strengthening]
  \label{lemma:subst-restr-fv}
  Restricting the substitution to the free variables of the
  substitution subject does not affect the result.
  Suppose that $[[Γ2 ⊢ σ : Γ1]]$. Then
    \begin{itemize}
  \item[$+$] if $[[Γ1 ⊢ iP]]$ then $[[ [σ]iP ]] = [[ [σ|fv iP]iP ]]$,
  \item[$-$] if $[[Γ1 ⊢ iN]]$ then $[[ [σ]iN ]] = [[ [σ|fv iN]iN ]]$
  \end{itemize}
\end{lemma}
\begin{proof}
  \ilyam{todo}
\end{proof}

\begin{lemma}[]
  Suppose that $[[{Γ'} ⊆ {Γ}]]$,
  $[[σ1]]$ and $[[σ2]]$ are substitutions of signature $[[Γ ⊢ σi : Γ']]$.
  Then 
  \begin{enumerate}
    \item [$+$] for a type $[[Γ ⊢ iP]]$, if $[[Γ ⊢ [σ1]iP ≈ [σ2]iP]]$ then 
    $[[Γ ⊢ σ1 ≈ σ2 : fv iP ∩ {Γ'}]]$;
    \item [$-$] for a type $[[Γ ⊢ iN]]$, if $[[Γ ⊢ [σ1]iN ≈ [σ2]iN]]$ then
    $[[Γ ⊢ σ1 ≈ σ2 : fv iN ∩ {Γ'}]]$.
  \end{enumerate}
\end{lemma}
\begin{proof}
  Let us make an additional assumption that $[[σ1]]$, $[[σ2]]$, 
  and the mentioned types are normalized. If they are not,
  we normalize them first.
  
  Notice that the normalization preserves
  the set of free variables (\cref{lemma:fv-nf}),
  well-formedness (\cref{corollary:wf-nf}), 
  and equivalence (\cref{lemma:subt-equiv-algorithmization}), 
  and distributes over substitution (\cref{lemma:norm-subst-distr}). 
  This way, the assumed and desired properties are equivalent to their 
  normalized versions.

  We prove it by induction on the structure of $[[iP]]$ and mutually, $[[iN]]$.
  Let us consider the shape of this type.
  \begin{caseof}
    \item $[[iP]] = [[α⁺]] \in [[Γ']]$.
      Then $[[Γ ⊢ σ1 ≈ σ2 : fv iP ∩ {Γ'}]]$ means $[[Γ ⊢ σ1 ≈ σ2 : {α⁺}]]$, 
      i.e. $[[Γ ⊢ [σ1]α⁺ ≈ [σ2]α⁺ ]]$, which holds by assumption.
    \item $[[iP]] = [[α⁺]] \in [[{Γ} \ {Γ'}]]$.
      Then $[[fv iP ∩ {Γ'}]] = [[∅]]$, 
      so $[[Γ ⊢ σ1 ≈ σ2 : fv iP ∩ {Γ'}]]$ holds vacuously.
    \item $[[iP]] = [[↓iN]]$.
      Then the induction hypothesis is applicable to type $[[iN]]$:
      \begin{enumerate}
        \item $[[iN]]$ is normalized,
        \item $[[Γ ⊢ iN]]$ by inversion of $[[Γ ⊢ ↓iN]]$,
        \item $[[Γ ⊢ [σ1]iN ≈ [σ2]iN]]$ holds by inversion of 
          $[[Γ ⊢ [σ1]↓iN ≈ [σ2]↓iN]]$, i.e. $[[Γ ⊢ ↓[σ1]iN ≈ ↓[σ2]iN]]$.
      \end{enumerate}
      This way, we obtain $[[Γ ⊢ σ1 ≈ σ2 : fv iN ∩ {Γ'}]]$, 
      which implies the required equivalence since 
      $[[fv iP ∩ {Γ'}]] = [[fv ↓iN ∩ {Γ'}]] = [[fv iN ∩ {Γ'}]]$.
    \item $[[iP]] = [[∃nas.iQ]]$
      Then the induction hypothesis is applicable to type $[[iQ]]$ 
      well-formed in context $[[Γ, nas]]$:
      \begin{enumerate}
        \item $[[{Γ'} ⊆ {Γ, nas}]]$ since $[[{Γ'} ⊆ {Γ}]]$,
        \item $[[Γ, nas ⊢ σi : Γ']]$ by weakening,
        \item $[[iQ]]$ is normalized,
        \item $[[Γ, nas ⊢ iQ]]$ by inversion of $[[Γ ⊢ ∃nas.iQ]]$,
        \item Notice that $[[ [σi]∃nas.iQ ]]$ is normalized, and thus, 
          $[[ [σ1]∃nas.iQ ≈ [σ2]∃nas.iQ]]$ implies 
          $[[ [σ1]∃nas.iQ = [σ2]∃nas.iQ ]]$
          (by \cref{lemma:subt-equiv-algorithmization}).).
          This equality means $[[ [σ1]iQ = [σ2]iQ ]]$, 
          which implies $[[Γ ⊢ [σ1]iQ ≈ [σ2]iQ]]$.
      \end{enumerate}
    \item $[[iN]] = [[iP → iM]]$
  \end{caseof}
\end{proof}

\begin{lemma}[Substitutions equivalent on the metavariables]
  \label{lemma:subst-equiv-metavar}
  Suppose that $[[Γ ⊢ Θ]]$, $[[uσ1]]$ and $[[uσ2]]$ are substitutions 
  of signature $[[Θ ⊢ uσi]]$.
  Then 
  \begin{enumerate}
    \item [$+$] for a type $[[Γ; Θ ⊢ uP]]$, if $[[Γ ⊢ [uσ1]uP ≈ [uσ2]uP]]$ then
      $[[Θ ⊢ uσ1 ≈ uσ2 : uv uP]]$;
    \item [$-$] for a type $[[Γ; Θ ⊢ uN]]$, if $[[Γ ⊢ [uσ1]uN ≈ [uσ2]uN]]$ then
      $[[Θ ⊢ uσ1 ≈ uσ2 : uv uN]]$.
  \end{enumerate}
\end{lemma}
\begin{proof}
  The proof is a trivial structural induction on 
  $[[Γ; Θ ⊢ uP]]$ and mutually, on $[[Γ; Θ ⊢ uN]]$.
\end{proof}


\begin{lemma}[Substitution composition well-formedness]
  If $[[Γ'1 ⊢ σ1 : Γ1]]$ and $[[Γ'2 ⊢ σ2 : Γ2]]$,
  then $[[Γ'1, Γ'2 ⊢ σ2 ○ σ1 : Γ1, Γ2]]$.
\end{lemma}

\begin{lemma}[Substitution monadic composition well-formedness]
  \label{lemma:subst-monad-composition-wf}
  If $[[Γ'1 ⊢ σ1 : Γ1]]$ and $[[Γ'2 ⊢ σ2 : Γ2]]$,
  then $[[Γ'2 ⊢ σ2 <=< σ1 : Γ1]]$.
\end{lemma}

\begin{lemma}[Substitution composition]
  \label{lemma:subst-composition}
    If $[[Γ'1 ⊢ σ1 : Γ1]]$, $[[Γ'2 ⊢ σ2 : Γ2]]$, 
    $[[{Γ1} ∩ {Γ'2} = ∅ ]]$ and $[[ {Γ1} ∩ {Γ2} = ∅ ]]$ then 
    $[[ σ2 ○ σ1 ]] = [[ (σ2 <=< σ1) ○ σ2 ]]$.
\end{lemma}

\begin{corollary}[Substitution composition commutativity]
  \label{corollary:subst-composition-commutativity}
  If $[[Γ'1 ⊢ σ1 : Γ1]]$, $[[Γ'2 ⊢ σ2 : Γ2]]$, and
  $[[ {Γ1} ∩ {Γ2} = ∅ ]]$, 
  $[[ {Γ1} ∩ {Γ'2} = ∅ ]]$, and
  $[[ {Γ'1} ∩ {Γ2} = ∅ ]]$ then 
  $[[ σ2 ○ σ1 ]] = [[ σ1 ○ σ2 ]]$.
\end{corollary}
\begin{proof}
  by \cref{lemma:subst-composition},
    $[[ σ2 ○ σ1 ]] = [[ (σ2 <=< σ1) ○ σ2 ]]$.
    Since the codomain of $[[σ1]]$ is $[[Γ'1]]$,
    and it is disjoint with the domain of $[[σ2]]$,
    $[[σ2 <=< σ1]] = [[σ1]]$.
\end{proof}

\begin{lemma}[Substitution domain weakening]
  \label{lemma:subst-domain-weakening}
  If $[[Γ2 ⊢ σ : Γ1]]$ and $[[ {Γ2'} ⊆ {Γ} ]]$ then $[[Γ2 ⊢ σ : Γ1, Γ2']]$
\end{lemma}
\begin{proof}
  If the variable $[[α±]]$ is in $[[Γ1]]$ then $[[Γ2 ⊢ [σ]α± ]]$ by assumption.
  If the variable $[[α±]]$ is in $[[{Γ2'} \ {Γ1}]]$ then $[[ [σ]α± = α± ]] \in [[Γ2']] ⊆ [[Γ2]]$, 
  and thus, $[[Γ2 ⊢ α± ]]$.
\end{proof}
